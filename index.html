<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <meta name="description" content="Wake Map - The Ultimate Execution Protocol">
    
    <!-- PWA MANIFEST & SETTINGS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wake Map">
    
    <!-- Favicon & App Icon -->
    <link rel="icon" type="image/png" href="https://placehold.co/64x64/020617/06b6d4.png?text=WM">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/020617/06b6d4.png?text=WM">
    
    <!-- Inline Manifest for PWA Installation -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiV2FrZSBNYXAgLSBVbHRpbWF0ZSBBcmNoaXRlY3QiLCJzaG9ydF9uYW1lIjoiV2FrZU1hcCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDIwNjE3IiwidGhlbWVfY29sb3IiOiIjMDIwNjE3IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDIwNjE3LzA2YjZkNC5wbmc/dGV4dD1XTSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDIwNjE3LzA2YjZkNC5wbmc/dGV4dD1XTSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19'>

    <title>Wake Map - Ultimate Architect</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&family=Audiowide&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        display: ['Audiowide', 'cursive'],
                    },
                    colors: {
                        // Dynamic Theme Colors mapped to CSS Variables
                        obsidian: "var(--bg-app)",      
                        charcoal: "var(--bg-panel)",    
                        surface: "var(--bg-card)",      
                        
                        // Text Colors
                        white: "var(--text-main)",      
                        slate: {
                            400: "var(--text-muted)",   
                            500: "var(--text-dim)",     
                            700: "var(--border-dim)",   
                            800: "var(--bg-input)"      
                        },

                        // Accents (Dynamic)
                        neonCyan: "var(--accent-primary)", 
                        
                        // Functional Colors
                        iron: "#334155",
                        neonPurple: "#8b5cf6",
                        neonGold: "#f59e0b",
                        neonRed: "#ef4444",
                        neonGreen: "#10b981",
                        glass: "rgba(15, 23, 42, 0.65)",
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulseGlow 3s infinite alternate',
                        'shimmer': 'shimmer 2.5s linear infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        pulseGlow: {
                            '0%': { boxShadow: '0 0 5px currentColor' },
                            '100%': { boxShadow: '0 0 20px currentColor' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 10px -10px #f59e0b' },
                            'to': { boxShadow: '0 0 20px 5px #f59e0b' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- CORE STYLESHEET -->
    <style>
        :root {
            --ease-expo: cubic-bezier(0.19, 1, 0.22, 1);
            
            /* DEFAULT THEME (Cyan/Obsidian) */
            --bg-app: #020617;
            --bg-panel: #0f172a;
            --bg-card: #1e293b;
            --bg-glass: rgba(15, 23, 42, 0.65);
            --bg-input: #1e293b;
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            
            --border-dim: #334155;
            
            --accent-primary: #06b6d4;
        }

        body { background-color: var(--bg-app); color: var(--text-muted); overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; transition: background-color 0.5s ease, color 0.3s ease; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism System */
        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: background 0.3s, border 0.3s, box-shadow 0.3s;
        }
        .glass-card:active { background: var(--bg-panel); }

        /* Button Interactions */
        .btn-action { position: relative; overflow: hidden; transition: all 0.3s var(--ease-expo); }
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-action:hover::after { left: 100%; }
        .btn-action:active { transform: scale(0.96); }

      /* TIER VISUAL SYSTEM (HIERARCHY UPDATE) */
        
        /* --- TIER LOW (NO GLOW) --- */
        /* F - Failing: Asphalt Gray */
        .tier-f { color: #3A3A3A; font-weight: 600; } 
        
        /* E - Elementary: Mud Brown */
        .tier-e { color: #6B4F3F; font-weight: 600; }
        
        /* D - Developing: Army Green */
        .tier-d { color: #4F6F52; font-weight: 600; }
        
        /* C - Capable: Teal Blue */
        .tier-c { color: #1F8A8A; font-weight: 700; }
        
        /* B - Balanced: True Blue */
        .tier-b { color: #2563EB; font-weight: 700; }   
        
        /* A - Advanced: Indigo */
        .tier-a { color: #3F2EFF; font-weight: 800; }

        /* --- TIER ELITE (SOFT GLOW/OUTLINE) --- */
        /* S - Superior: Royal Violet */
        .tier-s { 
            color: #7C3AED; 
            text-shadow: 0 0 10px rgba(124, 58, 237, 0.4); 
        }
        
        /* SS - Supremely Skilled: Fuchsia Core */
        .tier-ss { 
            color: #D946EF; 
            text-shadow: 0 0 12px rgba(217, 70, 239, 0.5); 
        }
        
        /* EX - Exceptional: Metallic Gold */
        .tier-ex { 
            background: linear-gradient(135deg, #D4AF37 30%, #F3E5AB 50%, #D4AF37 70%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
        }

        /* --- TIER GOD/ANOMALY (SPECIAL EFFECTS) --- */
        /* MR - Master Rank: Amber Orange (Solid Control) */
        .tier-mr { 
            color: #FF8C00; 
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.4);
            filter: contrast(1.2);
        }
        
        /* UR - Ultra Rare: Electric Cyan (Anomaly) */
        .tier-ur { 
            color: #00E5FF; 
            text-shadow: 0 0 8px #00E5FF, 0 0 20px rgba(0, 229, 255, 0.4); 
            animation: pulse-slow 4s infinite; 
        }
        
        /* EXR - Extreme Rank: Blood Red (Threat) */
        .tier-exr { 
            color: #B11226; 
            text-shadow: 0 0 15px rgba(177, 18, 38, 0.8); 
            letter-spacing: 1px;
        }
        
        /* HS - High Spec: Magma (Overclocked) */
        .tier-hs { 
            background: linear-gradient(to bottom, #FF4500, #FF8C00); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.6));
            animation: glow 3s infinite alternate;
        }
        
        /* PS - Peak State: Absolute White (Perfection) */
        .tier-ps { 
            color: #FFFFFF; 
            text-shadow: 0 0 10px rgba(255,255,255,0.8); 
            -webkit-text-stroke: 1px #111; /* Outline Gelap Wajib */
        }
        
        /* MA - MAXIMUM: Void Black (Final Form) */
        .tier-max { 
            color: #000000; 
            -webkit-text-stroke: 1px rgba(255,255,255,0.6); 
            text-shadow: 0 0 20px #7C3AED, 0 0 40px #B11226; /* Cosmic Glow: Ungu & Merah Tipis */
            animation: float 6s ease-in-out infinite; 
        }
        /* Navigation Dock */
        .nav-dock {
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        }
        .nav-item { position: relative; color: var(--text-dim); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: var(--accent-primary); transform: translateY(-4px); }
        .nav-item.active .nav-icon { filter: drop-shadow(0 4px 8px rgba(var(--accent-primary),0.4)); stroke-width: 2.5px; }
        .nav-indicator { width: 4px; height: 4px; background: var(--accent-primary); border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; box-shadow: 0 0 8px var(--accent-primary); }
        .nav-item.active .nav-indicator { transform: translateX(-50%) scale(1); }

        /* Toast & Overlays */
        #toast-layer { position: fixed; top: 20px; left: 0; right: 0; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast-msg { background: var(--bg-panel); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(-20px); opacity: 0; animation: toastEnter 0.4s forwards; }
        @keyframes toastEnter { to { transform: translateY(0); opacity: 1; } }
        @keyframes toastExit { to { transform: translateY(-20px); opacity: 0; } }

        /* Calendar Grid */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 10px; font-weight: bold; border: 1px solid transparent; transition: all 0.2s; position: relative; }
        .cal-cell.active { background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.5); color: #fff; }
        .cal-cell:hover { background: rgba(255,255,255,0.05); }

        /* Particle Canvas */
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; }
        .ambient-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.05) 0%, transparent 50%), radial-gradient(circle at 100% 100%, rgba(139,92,246,0.05) 0%, transparent 50%); }
    </style>
</head>
<body class="font-sans text-sm antialiased text-textMain">

    <!-- APP SHELL -->
    <div id="app-root" class="relative w-full max-w-md mx-auto h-screen flex flex-col bg-obsidian shadow-2xl border-x border-white/5 overflow-hidden">
        
        <!-- Background Systems -->
        <canvas id="particle-canvas"></canvas>
        <div class="ambient-layer"></div>

        <!-- 1. HEADER -->
        <header id="app-header" class="flex-none pt-10 pb-4 px-6 z-20 border-b border-white/5 bg-gradient-to-b from-obsidian via-obsidian/95 to-transparent backdrop-blur-sm">
             <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-tight flex items-center gap-2 font-display">
                        <span class="text-neonCyan drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">WAKE</span>MAP
                    </h1>
                    <div onclick="window.location.reload()" class="flex items-center gap-2 mt-1 cursor-pointer group select-none">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neonGreen opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-neonGreen"></span>
                        </span>
                        <p id="header-status" class="text-neonCyan/70 text-[10px] font-mono tracking-[0.2em] group-hover:text-neonCyan group-active:text-white transition-colors">TAP TO RELOAD</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.controller.openSettings()" class="glass-card p-2 rounded-lg hover:border-neonCyan/50 transition-colors text-slate-400 hover:text-white">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <div class="glass-card px-4 py-2 rounded-lg group hover:border-neonCyan/30 transition-colors cursor-default">
                        <span id="header-month" class="text-[10px] font-bold text-white uppercase tracking-[0.15em] group-hover:text-neonCyan transition-colors">...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 2. MAIN VIEWPORT -->
        <main id="app-viewport" class="flex-1 overflow-y-auto overscroll-y-contain px-5 py-6 hide-scroll relative z-10 space-y-8 scroll-smooth">
            <!-- Injected by Router -->
        </main>

        <!-- 3. NAVIGATION -->
        <nav id="app-nav" class="flex-none h-24 px-6 pb-6 pt-2 z-30 bg-gradient-to-t from-obsidian via-obsidian/95 to-transparent pointer-events-none">
            <div id="nav-inner" class="glass-card w-full h-full rounded-2xl flex items-center justify-around px-2 shadow-2xl backdrop-blur-xl pointer-events-auto">
                <!-- Injected by NavComponent -->
            </div>
        </nav>

        <!-- 4. OVERLAYS -->
        <div id="toast-layer"></div>
        <div id="modal-layer" class="fixed inset-0 z-50 pointer-events-none flex items-end sm:items-center justify-center transition-all duration-300 opacity-0 invisible backdrop-blur-sm bg-black/60"></div>

    </div>

    <!-- 
        ========================================================================
        JAVASCRIPT ARCHITECTURE
        ========================================================================
    -->
    <script>
        /**
         * MODULE 1: CONFIGURATION & CONSTANTS
         */
        const Config = {
            APP_NAME: 'Wake Map',
            VERSION: '7.8.3-FIXED-GIFT',
            STORAGE_PREFIX: 'wakemap_arch_',
            
            // THEME DEFINITIONS
            THEMES: [
                { id: 'default', label: 'Default', colors: { '--bg-app': '#020617', '--bg-panel': '#0f172a', '--bg-card': '#1e293b', '--bg-glass': 'rgba(15, 23, 42, 0.65)', '--bg-input': '#1e293b', '--text-main': '#ffffff', '--text-muted': '#94a3b8', '--text-dim': '#64748b', '--border-dim': '#334155', '--accent-primary': '#06b6d4' }, preview: 'bg-cyan-500' },
                { id: 'emerald', label: 'Emerald', colors: { '--bg-app': '#020617', '--bg-panel': '#022c22', '--bg-card': '#064e3b', '--bg-glass': 'rgba(6, 78, 59, 0.65)', '--bg-input': '#065f46', '--text-main': '#ffffff', '--text-muted': '#a7f3d0', '--text-dim': '#34d399', '--border-dim': '#059669', '--accent-primary': '#10b981' }, preview: 'bg-emerald-500' },
                { id: 'amber', label: 'Amber', colors: { '--bg-app': '#1c1917', '--bg-panel': '#292524', '--bg-card': '#44403c', '--bg-glass': 'rgba(41, 37, 36, 0.75)', '--bg-input': '#57534e', '--text-main': '#fffbeb', '--text-muted': '#d6d3d1', '--text-dim': '#a8a29e', '--border-dim': '#57534e', '--accent-primary': '#f59e0b' }, preview: 'bg-amber-500' },
                { id: 'crimson', label: 'Crimson', colors: { '--bg-app': '#2b0a0a', '--bg-panel': '#450a0a', '--bg-card': '#551010', '--bg-glass': 'rgba(69, 10, 10, 0.7)', '--bg-input': '#7f1d1d', '--text-main': '#fef2f2', '--text-muted': '#fecaca', '--text-dim': '#f87171', '--border-dim': '#991b1b', '--accent-primary': '#ef4444' }, preview: 'bg-red-600' },
                { id: 'violet', label: 'Violet', colors: { '--bg-app': '#1e1b4b', '--bg-panel': '#312e81', '--bg-card': '#4338ca', '--bg-glass': 'rgba(49, 46, 129, 0.65)', '--bg-input': '#3730a3', '--text-main': '#e0e7ff', '--text-muted': '#a5b4fc', '--text-dim': '#818cf8', '--border-dim': '#4f46e5', '--accent-primary': '#c084fc' }, preview: 'bg-purple-500' },
                { id: 'light', label: 'Minimalist', colors: { '--bg-app': '#f1f5f9', '--bg-panel': '#cbd5e1', '--bg-card': '#e2e8f0', '--bg-glass': 'rgba(255, 255, 255, 0.6)', '--bg-input': '#f8fafc', '--text-main': '#0f172a', '--text-muted': '#475569', '--text-dim': '#64748b', '--border-dim': '#cbd5e1', '--accent-primary': '#1e3a8a' }, preview: 'bg-slate-200 border border-slate-400' }
            ],

            // Goal Categories
            GOAL_CATEGORIES: [
                { id: 'disiplin', label: 'Disiplin', color: 'text-neonCyan', border: 'border-neonCyan' },
                { id: 'finansial', label: 'Finansial', color: 'text-neonGold', border: 'border-neonGold' },
                { id: 'kesehatan', label: 'Kesehatan', color: 'text-neonGreen', border: 'border-neonGreen' },
                { id: 'skill', label: 'Skill', color: 'text-neonPurple', border: 'border-neonPurple' },
                { id: 'lainnya', label: 'Lainnya', color: 'text-slate-400', border: 'border-slate-500' }
            ],

            
            // Time Protocol (HOURLY PRECISION)
            TIME_SLOTS: [
                // Generate jam 00 - 23 secara otomatis
                ...Array.from({length: 24}, (_, i) => {
                    const next = (i + 1) % 24;
                    const label = `${String(i).padStart(2, '0')}:00`;
                    const range = `${String(i).padStart(2, '0')}:00 - ${String(next).padStart(2, '0')}:00`;
                    return { 
                        id: `h${i}`, 
                        label: label, 
                        range: range, 
                        start: i, 
                        end: i + 1, 
                        desc: 'Hourly Focus' 
                    };
                }),
                // Slot All Day tetap ada
                { id: 'all',  label: 'ALL DAY',  range: '00:00 - 24:00', start: 0, end: 24, desc: 'Full Day Cycle' }
            ],

           // Rank Definitions (FINAL SPECTRUM)
            TIERS: [
                { id:0, code:'F', name:'FAILING', class:'tier-f', barColor:'#3A3A3A', bonus: 0 },
                { id:1, code:'E', name:'ELEMENTARY', class:'tier-e', barColor:'#6B4F3F', bonus: 25 },
                { id:2, code:'D', name:'DEVELOPING', class:'tier-d', barColor:'#4F6F52', bonus: 50 },
                { id:3, code:'C', name:'CAPABLE', class:'tier-c', barColor:'#1F8A8A', bonus: 100 },
                { id:4, code:'B', name:'BALANCED', class:'tier-b', barColor:'#2563EB', bonus: 200 },
                { id:5, code:'A', name:'ADVANCED', class:'tier-a', barColor:'#3F2EFF', bonus: 350 },
                { id:6, code:'S', name:'SUPERIOR', class:'tier-s', barColor:'#7C3AED', bonus: 500 },
                { id:7, code:'SS', name:'SUPREMELY SKILLED', class:'tier-ss', barColor:'#D946EF', bonus: 750 },
                { id:8, code:'EX', name:'EXCEPTIONAL', class:'tier-ex', barColor:'#D4AF37', bonus: 1000 },
                { id:9, code:'MR', name:'MASTER RANK', class:'tier-mr', barColor:'#FF8C00', bonus: 1500 },
                { id:10, code:'UR', name:'ULTRA RARE', class:'tier-ur', barColor:'#00E5FF', bonus: 2000 },
                { id:11, code:'EXR', name:'EXTREME RANK', class:'tier-exr', barColor:'#B11226', bonus: 3000 },
                { id:12, code:'HS', name:'HIGH SPEC', class:'tier-hs', barColor:'#FF4500', bonus: 5000 },
                { id:13, code:'PS', name:'PEAK STATE', class:'tier-ps', barColor:'#FFFFFF', bonus: 7500 },
                { id:14, code:'MA', name:'MAXIMUM', class:'tier-max', barColor:'#000000', bonus: 10000 }
            ],

            // Difficulty Settings
            DIFFICULTY: {
                easy: { id: 'easy', label: 'Mudah', pts: 2, color: 'text-neonGreen', border: 'border-neonGreen', hex: '#10b981' },
                medium: { id: 'medium', label: 'Sedang', pts: 4, color: 'text-neonCyan', border: 'border-neonCyan', hex: '#06b6d4' },
                hard: { id: 'hard', label: 'Sulit', pts: 6, color: 'text-neonPurple', border: 'border-neonPurple', hex: '#8b5cf6' }
            },

            // Productivity Modes
            PRODUCTIVITY_MODES: [
                { id: 'hibernasi', label: 'Hibernasi', pts: 8, desc: 'Recovery Mode', icon: 'battery-charging', color: 'text-slate-400' },
                { id: 'inisiasi', label: 'Inisiasi', pts: 16, desc: 'Starter', icon: 'sprout', color: 'text-neonGreen' },
                { id: 'standar', label: 'Standar', pts: 24, desc: 'Balanced', icon: 'scale', color: 'text-neonCyan' },
                { id: 'akselerasi', label: 'Akselerasi', pts: 36, desc: 'High Perf', icon: 'zap', color: 'text-neonPurple' },
                { id: 'dominasi', label: 'Dominasi', pts: 50, desc: 'Elite', icon: 'flame', color: 'text-neonRed' },
                { id: 'god', label: 'God Tier', pts: 70, desc: 'Limitless', icon: 'crown', color: 'text-neonGold' }
            ],
            
            ACHIEVEMENT_TIERS: {
                common: { id: 'common', label: 'Iron', bg: 'bg-slate-700', border: 'border-slate-500', glow: 'none' }
            }
        };

        /**
         * MODULE 2: UTILITIES
         */
        class Utils {
            static generateId() { 
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            static getISO(d = new Date()) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            }
            static getTomorrow() { 
                const d = new Date(); d.setDate(d.getDate()+1); 
                return this.getISO(d); 
            }
            static getMonthKey(iso) {
                return iso.slice(0, 7);
            }
            static formatMonth(iso) { 
                const [y,m]=iso.split('-'); 
                return new Date(y,parseInt(m)-1).toLocaleDateString('id-ID',{month:'long',year:'numeric'}).toUpperCase(); 
            }
            static formatDate(iso) { 
                return new Date(iso).toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); 
            }
            static formatCurrency(n) { 
                return new Intl.NumberFormat('id-ID').format(n); 
            }
            static getCurrentSlot() {
                const h = new Date().getHours();
                return Config.TIME_SLOTS.find(s => s.id !== 'all' && h >= s.start && h < s.end) || Config.TIME_SLOTS[0];
            }
        }

        /**
         * MODULE 3: DATA SERVICES (MODEL)
         */
        class Store {
            static get(key) { 
                try { 
                    const data = localStorage.getItem(Config.STORAGE_PREFIX + key);
                    if (key === 'settings') return data ? JSON.parse(data) : { muted: false, theme: 'default' };
                    return data ? JSON.parse(data) : []; 
                } catch { return key === 'settings' ? { muted: false, theme: 'default' } : []; } 
            }
            static set(key, data) { 
                localStorage.setItem(Config.STORAGE_PREFIX + key, JSON.stringify(data)); 
            }
           static prune(years) {
                const now = new Date();
                now.setFullYear(now.getFullYear() - years);
                const limitDate = Utils.getISO(now);
                const limitMonth = limitDate.slice(0, 7);

                // --- BAGIAN INI DIMODIFIKASI UNTUK SELAMATKAN POIN ---
                let tasks = this.get('tasks');
                const tCount = tasks.length;
                
                // 1. Ambil task tua yang akan dihapus
                const tasksToDelete = tasks.filter(t => t.date < limitDate);
                const tasksToKeep = tasks.filter(t => t.date >= limitDate);
                
                if (tasksToDelete.length > 0) {
                    // 2. Hitung poin dari task yang mau dihapus
                    const pointsToArchive = tasksToDelete.reduce((acc, t) => {
                        return acc + (t.status === 'completed' ? (Config.DIFFICULTY[t.difficulty]?.pts || 0) : 0);
                    }, 0);

                    // 3. Simpan poin itu ke 'archived_points' di Settings
                    const settings = this.get('settings');
                    settings.archivedPoints = (settings.archivedPoints || 0) + pointsToArchive;
                    this.set('settings', settings);

                    // 4. Baru hapus task-nya
                    this.set('tasks', tasksToKeep);
                    console.log(`Pruned: ${tasksToDelete.length} tasks. Archived Points: ${pointsToArchive}`);
                }
                // -----------------------------------------------------

                let refs = this.get('reflections');
                const rCount = refs.length;
                refs = refs.filter(r => r.date >= limitDate);
                if(refs.length < rCount) this.set('reflections', refs);

                let fins = this.get('finance');
                const fCount = fins.length;
                fins = fins.filter(f => f.month >= limitMonth);
                if(fins.length < fCount) this.set('finance', fins);

                let rewards = this.get('rewards');
                const rwdCount = rewards.length;
                rewards = rewards.filter(r => r.status === 'active' || (r.redeemedDate && r.redeemedDate >= limitDate));
                if(rewards.length < rwdCount) this.set('rewards', rewards);
            }
        }

        /**
         * MODULE 4: AUDIO SYSTEM
         */
        class SoundEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const settings = Store.get('settings');
                this.muted = settings ? settings.muted : false;
            }

            setMuted(val) {
                this.muted = val;
                const currentSettings = Store.get('settings');
                Store.set('settings', { ...currentSettings, muted: val });
            }

            play(type) {
                if (this.muted) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;

                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    
                    // --- PERBAIKAN DI SINI ---
                    // Tadinya 0.1 (10%), ganti jadi 0.5 (50%) supaya "tek" nya kedengeran mantap
                    gain.gain.setValueAtTime(0.5, now); 
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    
                    osc.start(now);
                    osc.stop(now + 0.1);

                } else if (type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now); 
                    osc.frequency.setValueAtTime(554, now + 0.1); 
                    osc.frequency.setValueAtTime(659, now + 0.2); 
                    
                    // --- PERBAIKAN DI SINI ---
                    // Tadinya 0.1, naikkan jadi 0.4 supaya bunyi "ting!" jelas
                    gain.gain.setValueAtTime(0.4, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    
                    osc.start(now);
                    osc.stop(now + 0.4);

                } else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    
                    // --- PERBAIKAN DI SINI ---
                    // Tadinya 0.1, naikkan jadi 0.4 supaya bunyi "tetot" jelas
                    gain.gain.setValueAtTime(0.4, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    
                    osc.start(now);
                    osc.stop(now + 0.3);

                } else if (type === 'nav') {
                      osc.type = 'sine';
                      osc.frequency.setValueAtTime(600, now);
                      
                      // --- PERBAIKAN DI SINI ---
                      // Tadinya 0.05 (kecil banget), naikkan jadi 0.2
                      gain.gain.setValueAtTime(0.2, now);
                      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                      
                      osc.start(now);
                      osc.stop(now + 0.05);
                }
            }
        }

       /**
         * MODULE 5: GAME ENGINE (LOGIC)
         */
        class Engine {
            // [UPDATE] Logika Sorting Cerdas (Chronological)
            static sortTasks(tasks) {
                return tasks.sort((a, b) => {
                    // Helper untuk menentukan "Bobot Waktu"
                    const getWeight = (t) => {
                        // 1. ALL DAY selalu paling bawah (Bobot Besar)
                        if (t.timeSlot === 'all') return 100;

                        // 2. Cek apakah pakai Custom Range (Sistem Baru)
                        if (t.customStart !== undefined && t.customStart !== null) {
                            return t.customStart;
                        }

                        // 3. Cek Slot ID (h0, h1, ... h23)
                        if (t.timeSlot && t.timeSlot.startsWith('h')) {
                            return parseInt(t.timeSlot.replace('h', ''));
                        }

                        // 4. Fallback untuk data legacy (jika ada)
                        const slot = Config.TIME_SLOTS.find(s => s.id === t.timeSlot);
                        return slot ? slot.start : 99;
                    };

                    const wA = getWeight(a);
                    const wB = getWeight(b);

                    // Jika jamnya sama, urutkan berdasarkan waktu pembuatan (yang duluan dibuat di atas)
                    if (wA === wB) {
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    }

                    return wA - wB; // Kecil (Pagi) ke Besar (Malam)
                });
            }

            // Updated Calc Expense Logic
            static calcExpense(monthKey, rewards) {
                if (!rewards || rewards.length === 0) return 0;
                return rewards.filter(r => r.status === 'redeemed' && r.redeemedDate && r.redeemedDate.startsWith(monthKey))
                              .reduce((acc, r) => acc + (r.cost || 0), 0);
            }

            static calcPoints(tasks) {
                const dObj = new Date();
                const today = Utils.getISO(dObj);
                const monthKey = today.slice(0, 7);
                const d = new Date(); d.setMonth(d.getMonth() - 1);
                const prevMonthKey = Utils.getISO(d).slice(0,7);
                
                const settings = Store.get('settings');
                const archived = settings.archivedPoints || 0;

                let cur = 0, mon = 0, last = 0;
                let total = archived; 

                tasks.forEach(t => {
                    if (t.status === 'completed') {
                        const pts = t.pts !== undefined ? t.pts : (Config.DIFFICULTY[t.difficulty]?.pts || 0);
                        total += pts; 

                        if (t.date === today) cur += pts;
                        if (t.date.startsWith(monthKey)) mon += pts;
                        if (t.date.startsWith(prevMonthKey)) last += pts;
                    }
                });

                const dayNum = dObj.getDate();
                const avg = dayNum > 0 ? (mon / dayNum).toFixed(1) : '0.0';

                return { cur, mon, last, avg, total };
            }
            
           static calcRank(monthKey, tasks, financeData) {
                let eTier=0, eBar=0, cTier=0, cBar=0;
                
                // [FIX] Filter tanggal: Hanya ambil misi bulan ini YANG TANGGALNYA <= HARI INI
                // Jangan hitung misi masa depan sebagai kegagalan!
                const today = Utils.getISO();
                const mTasks = tasks.filter(t => 
                    t.date.startsWith(monthKey) && 
                    t.date <= today &&  // <--- INI KUNCINYA
                    t.type !== 'bonus'
                );
                
                const config = financeData.find(f => f.month === monthKey);
                const dailyTarget = config ? config.targetPts : 10;

                const dates = [...new Set(mTasks.map(t => t.date))].sort();
                
                let eWins = 0;
                let cWins = 0;

                dates.forEach(d => {
                    const ts = mTasks.filter(t => t.date === d);
                    const done = ts.filter(t => t.status === 'completed').length;
                    const total = ts.length;
                    
                    const dayPoints = ts.reduce((acc, t) => acc + (t.status === 'completed' ? Config.DIFFICULTY[t.difficulty].pts : 0), 0);

                    if (done === total && total > 0) eWins++;
                    if (dayPoints >= dailyTarget) cWins++;
                });

                // ... (sisa logika tier sama) ...
                // Pastikan pakai Math.ceil untuk bars
                const maxTier = Config.TIERS.length - 1;
                let eTierIndex = Math.floor(eWins / 4);
                if (eTierIndex > maxTier) eTierIndex = maxTier;
                let eBars = Math.ceil((eWins % 4) / 2); 
                if (eTierIndex === maxTier) eBars = 2;

                let cTierIndex = Math.floor(cWins / 4);
                if (cTierIndex > maxTier) cTierIndex = maxTier;
                let cBars = Math.ceil((cWins % 4) / 2);
                if (cTierIndex === maxTier) cBars = 2;

                return { 
                    exec: { tier: Config.TIERS[eTierIndex], bars: eBars }, 
                    cons: { tier: Config.TIERS[cTierIndex], bars: cBars },
                    dailyTarget: dailyTarget
                };
            }

            // [UPDATE] Auto Fail Logic (Agar support Range Waktu Baru)
            static checkAutoFail(tasks) {
                const now = new Date();
                const today = Utils.getISO(now);
                const h = now.getHours();
                let hasChange = false;

                tasks.forEach(task => {
                    if (task.type === 'bonus') return;

                    if (task.status === 'pending') {
                        if (task.date < today) {
                            task.status = 'failed';
                            hasChange = true;
                        } 
                        else if (task.date === today) {
                            // --- LOGIKA BARU UNTUK RANGE ---
                            let endTime = 24; // Default (All Day)

                            if (task.customEnd !== undefined) {
                                // Jika pakai Range Manual (06-09), ambil end-nya (9)
                                endTime = task.customEnd;
                            } else {
                                // Jika pakai sistem lama (Compatibility)
                                const slot = Config.TIME_SLOTS.find(s => s.id === (task.timeSlot||'all'));
                                if(slot && slot.id !== 'all') endTime = slot.end;
                            }

                            // Jika jam sekarang >= jam berakhir, GAGAL.
                            if (h >= endTime) {
                                task.status = 'failed';
                                hasChange = true;
                            }
                        }
                    }
                });
                return hasChange;
            }
        }

        /**
         * MODULE 6: VISUAL EFFECTS SYSTEM
         */
        class VFXEngine {
            constructor() {
                this.canvas = document.getElementById('particle-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.particles = [];
                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i=0; i<40; i++) this.particles.push(this.createParticle());
                this.animate();
            }

            resize() {
                this.width = this.canvas.width = window.innerWidth;
                this.height = this.canvas.height = window.innerHeight;
            }

            createParticle() {
                return {
                    x: Math.random() * this.width,
                    y: Math.random() * this.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2,
                    alpha: Math.random() * 0.5
                };
            }

            animate() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if(p.x < 0) p.x = this.width;
                    if(p.x > this.width) p.x = 0;
                    if(p.y < 0) p.y = this.height;
                    if(p.y > this.height) p.y = 0;
                    
                    // Dynamic Particle Color
                    const accentColor = getComputedStyle(document.body).getPropertyValue('--accent-primary').trim();
                    this.ctx.fillStyle = accentColor || 'rgba(6, 182, 212, 0.5)'; 
                    this.ctx.globalAlpha = p.alpha;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.globalAlpha = 1.0;
                });
                requestAnimationFrame(() => this.animate());
            }
        }

        /**
         * MODULE 7: UI COMPONENT FACTORY
         */
        const ComponentFactory = {
            rankCard(title, data, icon) {
                const t = data.tier;
                const col = t.barColor;
                
                let bars = '';
                for(let i=1; i<=2; i++) {
                    const active = i <= data.bars;
                    const activeStyle = `background-color:${col}; box-shadow: 0 0 10px ${col}, 0 0 20px ${col}; border: 1px solid rgba(255,255,255,0.5);`;
                    const inactiveStyle = `background-color:var(--bg-panel); border: 1px solid var(--border-dim); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);`;
                    const style = active ? activeStyle : inactiveStyle;
                    
                    bars += `<div class="w-1/2 h-2 rounded-full transition-all duration-500" style="${style}"></div>`;
                }

                return `
                <div class="glass-card p-4 rounded-xl flex-1 flex flex-col items-center justify-between relative overflow-hidden group min-h-[120px] hover:bg-white/5 transition-colors cursor-default">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex items-center justify-between w-full mb-1 z-10">
                        <span class="text-[8px] font-mono text-slate-400 font-bold tracking-widest">${title}</span>
                        <i data-lucide="${icon}" class="w-3 h-3 text-slate-500"></i>
                    </div>

                    <div class="font-display text-4xl mb-1 z-10 transition-all duration-500" style="color:${col}; text-shadow: 0 0 15px ${col};">
                        ${t.code}
                    </div>

                    <div class="text-[8px] text-white font-bold tracking-[0.2em] z-10 mb-3 uppercase opacity-80">${t.name}</div>
                    <div class="flex gap-2 w-full max-w-[60px] z-10 mt-2">${bars}</div>
                </div>`;
            },

            analyticsCard(tasks) {
                const labels = [];
                const data = [];
                const today = new Date();
                
                for(let i=6; i>=0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const iso = Utils.getISO(d);
                    const dayName = d.toLocaleDateString('id-ID', {weekday:'short'}).toUpperCase().slice(0,3);
                    labels.push(dayName);
                    
                    const dayTasks = tasks.filter(t => t.date === iso && t.status === 'completed' && t.type !== 'bonus');
                    const pts = dayTasks.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);
                    data.push(pts);
                }

                const maxVal = Math.max(...data, 10); 
                const h = 60; 
                const w = 100;
                const stepX = w / (data.length - 1);
                
                let points = "";
                data.forEach((val, i) => {
                    const x = i * stepX;
                    const y = h - ((val / maxVal) * h);
                    points += `${x},${y} `;
                });

                return `
                <div class="glass-card p-4 rounded-xl mb-4 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 rounded bg-neonCyan/10"><i data-lucide="activity" class="w-3 h-3 text-neonCyan"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-300">Neural Analytics</span>
                        </div>
                        <span class="text-[9px] text-slate-500 font-mono">7 HARI TERAKHIR</span>
                    </div>
                    
                    <div class="relative h-16 w-full mt-2">
                        <div class="absolute inset-0 flex flex-col justify-between opacity-10">
                            <div class="border-t border-white/20 w-full"></div>
                            <div class="border-t border-white/20 w-full"></div>
                            <div class="border-t border-white/20 w-full"></div>
                        </div>
                        
                        <svg viewBox="0 0 100 60" preserveAspectRatio="none" class="w-full h-full overflow-visible">
                            <defs>
                                <linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="var(--accent-primary)" stop-opacity="0.3"/>
                                    <stop offset="100%" stop-color="var(--accent-primary)" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <polygon points="0,60 ${points} 100,60" fill="url(#chartGrad)" />
                            <polyline points="${points}" fill="none" stroke="var(--accent-primary)" stroke-width="2" vector-effect="non-scaling-stroke" />
                            ${data.map((val, i) => {
                                const x = i * stepX;
                                const y = h - ((val / maxVal) * h);
                                return `<circle cx="${x}" cy="${y}" r="3" class="fill-obsidian stroke-neonCyan" stroke-width="1.5" vector-effect="non-scaling-stroke"/>`;
                            }).join('')}
                        </svg>
                    </div>
                    
                    <div class="flex justify-between mt-2 px-1">
                        ${labels.map(l => `<span class="text-[8px] font-mono text-slate-500">${l}</span>`).join('')}
                    </div>
                </div>`;
            },

            // UPDATED: Use Config.TIERS instead of static achievement tiers
            achievementBadge(ach) {
                const tier = Config.TIERS[ach.tierIndex] || Config.TIERS[0];
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === ach.category) || {color:'text-white', label:''};
                
                return `
                <div class="glass-card flex flex-col items-center justify-center p-3 rounded-xl border border-white/10 relative overflow-hidden group hover:scale-105 transition-transform duration-300 shadow-[0_0_15px_rgba(0,0,0,0.3)] relative">
                    ${ach.isFinal ? `<div class="absolute top-1 right-1 text-neonGreen"><i data-lucide="check-circle-2" class="w-3 h-3"></i></div>` : ''}
                    <div class="p-2 rounded-full bg-black/30 mb-2 font-display text-xl" style="color: ${tier.barColor}; text-shadow: 0 0 10px ${tier.barColor}">
                        ${tier.code}
                    </div>
                    <span class="text-[9px] text-center font-bold text-white uppercase leading-tight">${ach.title}</span>
                    <span class="text-[8px] text-center text-white/60 font-mono mt-1">${Utils.formatDate(ach.dateUnlocked).split(',')[1]}</span>
                    
                    <span class="text-[9px] font-mono font-bold text-neonGold mt-1 border border-neonGold/30 px-1.5 rounded bg-black/40">+${Utils.formatCurrency(tier.bonus)} Pts</span>
                    
                    <span class="text-[7px] uppercase mt-1 px-1.5 py-0.5 rounded bg-black/30 ${cat.color}">${cat.label}</span>
                    <button onclick="if(confirm('Hapus snapshot sejarah ini?')){App.controller.deleteAchievement('${ach.id}')}" class="absolute top-1 left-1 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-neonRed transition-opacity"><i data-lucide="trash" class="w-3 h-3"></i></button>
                </div>`;
            },

            achievementStack(goalId, snapshots) {
                const latest = snapshots[snapshots.length - 1];
                const tier = Config.TIERS[latest.tierIndex] || Config.TIERS[0];
                const count = snapshots.length;
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === latest.category) || {color:'text-white', label:''};

                return `
                <div onclick="App.controller.openStackDetails('${goalId}')" class="glass-card flex flex-col items-center justify-center p-3 rounded-xl border border-white/10 relative overflow-hidden group hover:scale-105 transition-transform duration-300 cursor-pointer shadow-[0_0_15px_rgba(0,0,0,0.3)]">
                    <div class="absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-neonCyan text-obsidian font-bold text-[8px] rounded-bl-lg z-10">${count}</div>
                    
                    ${latest.isFinal ? `<div class="absolute top-1 right-5 text-neonGreen"><i data-lucide="check-circle-2" class="w-3 h-3"></i></div>` : ''}
                    
                    <div class="p-2 rounded-full bg-black/30 mb-2 font-display text-xl" style="color: ${tier.barColor}; text-shadow: 0 0 10px ${tier.barColor}">
                        ${tier.code}
                    </div>
                    <span class="text-[9px] text-center font-bold text-white uppercase leading-tight line-clamp-2">${latest.title}</span>
                    <span class="text-[8px] text-center text-white/60 font-mono mt-1">Updated: ${Utils.formatDate(latest.dateUnlocked).split(',')[1]}</span>
                    
                    <span class="text-[9px] font-mono font-bold text-neonGold mt-1 border border-neonGold/30 px-1.5 rounded bg-black/40">+${Utils.formatCurrency(tier.bonus)} Pts</span>

                    <span class="text-[7px] uppercase mt-1 px-1.5 py-0.5 rounded bg-black/30 ${cat.color}">${cat.label}</span>
                    
                    <div class="absolute bottom-0 inset-x-2 h-1 bg-white/10 rounded-t-sm"></div>
                    <div class="absolute bottom-1 inset-x-3 h-1 bg-white/5 rounded-t-sm"></div>
                </div>`;
            },

            goalCard(goal) {
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === goal.category) || {label:'Lainnya', color:'text-slate-400', border:'border-slate-500'};
                
                return `
                <div class="glass-card p-4 rounded-xl border ${cat.border} relative group min-w-[200px] flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="target" class="w-4 h-4 ${cat.color}"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest ${cat.color}">${cat.label}</span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="App.controller.editGoal('${goal.id}')" class="p-1 text-slate-400 hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="App.controller.deleteGoal('${goal.id}')" class="p-1 text-slate-400 hover:text-neonRed"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    
                    <h3 class="text-sm font-bold text-white mb-1">${goal.title}</h3>
                    <p class="text-xs text-slate-400 font-mono mb-4">
                        ${goal.type === 'progressive' ? `Target: <span class="text-white">${goal.currentTarget}</span>` : `<span class="text-neonGold font-bold">RANK ${Config.TIERS[goal.rankIndex].code}</span>`}
                    </p>
                    
                    <button onclick="App.controller.openSnapshotModal('${goal.id}')" class="w-full bg-slate-800 hover:bg-neonCyan hover:text-obsidian text-slate-300 text-[10px] font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 border border-slate-700">
                        <i data-lucide="camera" class="w-3 h-3"></i> CHECKPOINT
                    </button>
                </div>`;
            },

            taskItem(t, mode) { 
                
                // Cek apakah ini misi Custom Range atau Biasa
                let timeLabel = "ALL DAY";
                
                if (t.customLabel) {
                    timeLabel = t.customLabel; // Pakai label custom (06:00 - 09:00)
                } else {
                    const slot = Config.TIME_SLOTS.find(s=>s.id === (t.timeSlot||'all'));
                    if (slot) timeLabel = slot.label; // Fallback
                }
                const diff = Config.DIFFICULTY[t.difficulty] || {label:'BONUS', color:'text-neonGold', border:'border-neonGold'};
                
                if (t.type === 'bonus' && mode !== 'view') return ''; 

                let action = '';
                let cardClass = '';
                let textClass = 'text-white font-medium';

                if (t.type === 'bonus') {
                      cardClass = 'bg-neonGold/10 border-neonGold/30';
                      action = `<span class="text-xs font-bold text-neonGold">+${t.pts} PTS</span>`;
                      textClass = 'text-neonGold font-bold uppercase';
                }
                else if (t.status === 'completed') {
                    cardClass = 'bg-green-900/20 border-green-500/30 shadow-[0_0_10px_rgba(16,185,129,0.1)]';
                    action = `<i data-lucide="check-circle" class="text-neonGreen w-5 h-5 drop-shadow-md"></i>`;
                    textClass = 'text-neonGreen font-bold';
                } 
                else if (t.status === 'failed') {
                    cardClass = 'bg-red-900/20 border-red-500/30';
                    action = `<i data-lucide="x-circle" class="text-neonRed w-5 h-5 drop-shadow-md"></i>`;
                    textClass = 'text-neonRed font-bold';
                }
                else if (mode === 'active' && t.status === 'pending') {
                    cardClass = 'border-dashed border-slate-600 bg-transparent';
                    action = `
                    <div class="flex gap-2">
                        <button onclick="App.controller.updateTask('${t.id}','failed')" class="w-9 h-9 rounded-xl bg-slate-800 border border-neonRed/30 text-neonRed flex items-center justify-center hover:bg-neonRed/20 active:scale-95 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="App.controller.updateTask('${t.id}','completed')" class="w-9 h-9 rounded-xl bg-slate-800 border border-neonGreen/30 text-neonGreen flex items-center justify-center hover:bg-neonGreen/20 active:scale-95 transition-all shadow-[0_0_10px_rgba(16,185,129,0.2)]"><i data-lucide="check" class="w-4 h-4"></i></button>
                    </div>`;
                }
                else if (mode === 'locked' && t.status === 'pending') {
                    cardClass = 'glass-card opacity-80 border-slate-700';
                    action = `<i data-lucide="lock" class="text-slate-600 w-4 h-4"></i>`;
                }
                else if (mode === 'edit') {
                    cardClass = 'glass-card opacity-90';
                    action = `<button onclick="App.controller.deleteTask('${t.id}')" class="text-slate-500 hover:text-neonRed p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                }
                else {
                    cardClass = 'glass-card opacity-70';
                }

                return `
                <div class="p-4 rounded-xl flex items-center justify-between border mb-3 transition-all ${cardClass}">
                    <div class="flex-1 pr-3">
                        <div class="flex items-center gap-2 mb-1.5">
                            <span class="text-[8px] font-mono font-bold text-slate-300 bg-surface px-1.5 py-0.5 rounded border border-white/5">${timeLabel}</span>
                            ${t.type !== 'bonus' ? `<span class="text-[8px] font-bold border px-1.5 py-0.5 rounded uppercase ${diff.color} ${diff.border} bg-white/5">${diff.label}</span>` : ''}
                        </div>
                        <p class="text-sm ${textClass} leading-snug">${t.text}</p>
                    </div>
                    <div>${action}</div>
                </div>`;
            },

            rankLegend() {
                return Config.TIERS.slice().reverse().map(t => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                    <div class="font-display w-8 text-center text-lg ${t.class}">${t.code}</div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-white uppercase tracking-wider">${t.name}</div>
                        <!-- Baris tampilan bonus dihapus di sini -->
                    </div>
                </div>`).join('');
            }
        };

        /**
         * MODULE 8: MAIN CONTROLLER
         */
        const Controller = {
           // --- LOOP PROTOCOL (MISI BERKALA + KALKULATOR) ---
            openPeriodicModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                
                // Helper untuk opsi jam 00-23
                const hourOptions = Array.from({length: 24}, (_, i) => `<option value="${i}">${String(i).padStart(2,'0')}:00</option>`).join('');

                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1 flex items-center gap-2"><i data-lucide="repeat" class="w-5 h-5 text-neonPurple"></i> Loop Protocol</h3>
                            <p class="text-slate-400 text-xs font-mono">Penjadwalan Misi Otomatis.</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>

                    <div class="space-y-4 max-h-[70vh] overflow-y-auto custom-scroll pr-1">
                        <!-- Nama Misi -->
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Nama Misi</label>
                            <input id="loop-text" type="text" placeholder="Contoh: Lari Pagi..." class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonPurple outline-none">
                        </div>

                        <!-- Pilih Hari -->
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Aktif Pada Hari:</label>
                            <div class="flex justify-between gap-1">
                                ${['M','S','S','R','K','J','S'].map((d, i) => `
                                    <label class="cursor-pointer relative group">
                                        <input type="checkbox" name="loopDay" value="${i}" class="peer hidden" ${(i===1)?'checked':''} onchange="App.controller.calcLoopTotal()">
                                        <div class="w-8 h-8 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-slate-500 peer-checked:bg-neonPurple peer-checked:text-white peer-checked:border-neonPurple transition-all active:scale-90">
                                            ${d}
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Konfigurasi -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Total Muncul (Kali)</label>
                                <input id="loop-total" type="number" value="0" min="1" max="100" oninput="App.controller.calcLoopTotal()" class="w-full bg-surface text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonPurple outline-none text-center font-mono">
                            </div>
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Kesulitan</label>
                                <select id="loop-diff" onchange="App.controller.calcLoopTotal()" class="w-full bg-surface text-white rounded-lg px-3 py-2.5 text-xs border border-slate-700 outline-none">
                                    <option value="easy">Mudah (2 Pts)</option>
                                    <option value="medium">Sedang (4 Pts)</option>
                                    <option value="hard">Sulit (6 Pts)</option>
                                </select>
                            </div>
                        </div>

                        <!-- [REVISI] Waktu Eksekusi Range -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Mulai Jam</label>
                                <select id="loop-start" class="w-full bg-surface text-white rounded-lg px-3 py-2.5 text-xs border border-slate-700 outline-none font-mono">
                                    ${hourOptions}
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Selesai Jam</label>
                                <select id="loop-end" class="w-full bg-surface text-white rounded-lg px-3 py-2.5 text-xs border border-slate-700 outline-none font-mono">
                                    ${Array.from({length: 24}, (_, i) => `<option value="${i+1}" ${i===0?'selected':''}>${String(i+1).padStart(2,'0')}:00</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- Input Bonus Jackpot -->
                        <div class="bg-neonGold/5 p-3 rounded-xl border border-neonGold/20">
                            <label class="text-[9px] text-neonGold uppercase font-bold mb-1 block flex justify-between">
                                <span>Bonus Selesai (Jackpot)</span>
                                <i data-lucide="gift" class="w-3 h-3"></i>
                            </label>
                            <input id="loop-bonus" type="number" placeholder="0" value="0" oninput="App.controller.calcLoopTotal()" class="w-full bg-charcoal text-neonGold font-bold rounded-lg px-4 py-2 text-sm border border-slate-700 focus:border-neonGold outline-none placeholder:text-slate-600">
                        </div>

                        <div class="flex justify-between items-center px-2 py-2 border-t border-white/5">
                            <span class="text-[9px] text-slate-400">Total Nilai Loop:</span>
                            <span id="loop-calc-res" class="text-sm font-mono font-bold text-white">0 Pts</span>
                        </div>

                        <button onclick="App.controller.generateLoopTasks()" class="w-full bg-neonPurple text-white py-3 rounded-lg font-bold shadow-[0_0_15px_rgba(139,92,246,0.4)] hover:bg-white hover:text-neonPurple transition-all flex items-center justify-center gap-2">
                            <i data-lucide="cpu" class="w-4 h-4"></i> GENERATE PROTOCOL
                        </button>
                    </div>
                </div>`;
                
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
                this.calcLoopTotal();
            },
          generateLoopTasks() {
                const text = document.getElementById('loop-text').value.trim();
                const total = parseInt(document.getElementById('loop-total').value);
                const diff = document.getElementById('loop-diff').value;
                
                // [BARU] Ambil Waktu Range
                const start = parseInt(document.getElementById('loop-start').value);
                const end = parseInt(document.getElementById('loop-end').value);
                
                const bonusInput = document.getElementById('loop-bonus').value;
                const bonusPts = bonusInput ? parseInt(bonusInput) : 0;
                const selectedDays = Array.from(document.querySelectorAll('input[name="loopDay"]:checked')).map(cb => parseInt(cb.value));

                if (!text) { this.toast("Nama misi wajib diisi!", "error"); return; }
                if (isNaN(total) || total <= 0) { this.toast("Total repetisi tidak valid!", "error"); return; }
                if (selectedDays.length === 0) { this.toast("Pilih minimal satu hari!", "error"); return; }
                
                // [BARU] Validasi Waktu (Sama seperti Blueprint)
                if (end <= start) { this.toast("Jam selesai harus lebih besar dari mulai", "error"); return; }

                const tasks = Store.get('tasks');
                let createdCount = 0;
                let d = new Date(); 
                

                const basePts = Config.DIFFICULTY[diff].pts;
                
                // Label Waktu Otomatis
                const timeLabel = `${String(start).padStart(2,'0')}:00 - ${String(end).padStart(2,'0')}:00`;

                for (let i = 0; i < 365; i++) {
                    if (createdCount >= total) break;

                    const currentDayIndex = d.getDay();

                    if (selectedDays.includes(currentDayIndex)) {
                        const isLast = (createdCount === total - 1);
                        let finalPts = undefined; 
                        let finalText = `${text} (Loop ${createdCount + 1}/${total})`;

                        if (isLast && bonusPts > 0) {
                            finalPts = basePts + bonusPts;
                            finalText = ` ${text} (FINAL: +${bonusPts} PTS)`; 
                        }

                        tasks.push({
                            id: Utils.generateId(),
                            text: finalText,
                            difficulty: diff,
                            
                            // [PENTING] Set ke Custom & Masukkan Data Range
                            timeSlot: 'custom',
                            customStart: start,
                            customEnd: end,
                            customLabel: timeLabel,
                            
                            date: Utils.getISO(d),
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            pts: finalPts 
                        });
                        createdCount++;
                    }
                    d.setDate(d.getDate() + 1);
                }

                Store.set('tasks', tasks);
                this.sound.play('success');
                this.toast(`Protokol aktif! Jackpot ${bonusPts} Pts di akhir.`, 'success');
                this.closeModal();
                this.render();
            },
            state: {
                view: 'home',
                difficulty: 'easy',
                histMonth: Utils.getISO().slice(0, 7),
                histDate: null,
                tempTask: null,
                rewardStep: 0, 
                tempReward: { name: '', hasPrice: false, price: 0, cost: 0, recs: null },
                showIncomeInput: false,
                tempMode: null,
                tempIncome: '',
                tempAlloc: '',
                tempTaskInput: '',
                tempGoal: { id: null, title: '', target: '', category: 'lainnya', type: 'progressive', rankIndex: 0 },
                tempSnapshot: { goalId: null, milestone: '', isFinal: false, nextTarget: '', tierIndex: 0 },
                lastNotifTime: 0,
                tempBlueprintDiff: 'easy',
                tempTimeRange: { start: null, end: null },
                
                // [TAMBAHAN BARU] Tracker agar notif hanya muncul 1x per slot/hari
                notifiedTracker: { 
                    slot: null, // Menyimpan slot terakhir yg sudah dinotif (misal: "2023-10-27-core")
                    rewards: [] // Menyimpan ID hadiah yang sudah diberitahu bisa diklaim
                }
            },

            init() {
                new VFXEngine();
                this.sound = new SoundEngine();
                
                Store.prune(2);
                
                // Initialize Theme
                const settings = Store.get('settings');
                this.setTheme(settings.theme || 'default');

                const monthDisplay = document.getElementById('header-month');
                if (monthDisplay) {
                    monthDisplay.innerText = Utils.formatMonth(Utils.getMonthKey(Utils.getISO()));
                }

                this.render();

                setInterval(() => {
                    const tasks = Store.get('tasks');
                    let hasUpdate = false;

                    if (Engine.checkAutoFail(tasks)) {
                        Store.set('tasks', tasks);
                        this.sound.play('error'); 
                        this.toast('Status misi diperbarui!', 'error');
                        hasUpdate = true;
                    }

                    this.checkNotifications(tasks);

                    if(hasUpdate && this.state.view === 'home') this.render();
                }, 10000);
            },

            setTheme(themeId) {
                const theme = Config.THEMES.find(t => t.id === themeId) || Config.THEMES[0];
                const root = document.documentElement;
                
                Object.entries(theme.colors).forEach(([key, value]) => {
                    root.style.setProperty(key, value);
                });

                const settings = Store.get('settings');
                Store.set('settings', { ...settings, theme: themeId });
            },

           // --- UPDATED NOTIFICATION SYSTEM ---
            requestPermission() {
                if (!("Notification" in window)) {
                    this.toast("Browser ini tidak support notifikasi sistem.", "error");
                    return;
                }

                // Minta izin
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        this.toast("Sistem Notifikasi Diaktifkan!", "success");
                        this.sound.play('success');
                        
                        // Tes notifikasi langsung
                        this.showNotification("Wake Map Connected", "Sistem siap memantau misi Anda.");
                        
                        this.render(); // Refresh tampilan tombol settings
                    } else {
                        this.toast("Izin notifikasi ditolak oleh browser.", "error");
                    }
                });
            },

         checkNotifications(tasks) {
                // 1. Cek Izin
                if (!("Notification" in window) || Notification.permission !== "granted") return;

                const now = new Date();
                const currentHour = now.getHours();
                const today = Utils.getISO();
                
                // Key Unik: Tanggal + Jam (Contoh: "2024-10-27-h10")
                // Ini kuncinya agar notifikasi hanya bunyi 1x per jam (tidak spam)
                const currentNotifKey = `${today}-h${currentHour}`;

                // --- BAGIAN 1: NOTIFIKASI MISI (TIME BASED) ---
                // Hanya jalankan jika jam ini BELUM dinotifikasi
                if (this.state.notifiedTracker.slot !== currentNotifKey) {
                    
                    // A. Cari Misi yang MULAI jam ini (Start Hour == Current Hour)
                    const slotTasks = tasks.filter(t => {
                        // Filter dasar: Harus hari ini & belum selesai
                        if (t.date !== today || t.status !== 'pending') return false;
                        if (t.timeSlot === 'all') return false; // All day dipisah

                        // LOGIKA BARU: Cek Angka Jam Mulai
                        let startHour = -1;
                        
                        // Cek apakah pakai Custom Range (Misi Loop/Manual Baru)
                        if (t.customStart !== undefined && t.customStart !== null) {
                            startHour = t.customStart;
                        } 
                        // Cek apakah pakai Slot ID Lama (Data Lama)
                        else {
                            const slot = Config.TIME_SLOTS.find(s => s.id === t.timeSlot);
                            if (slot) startHour = slot.start;
                        }

                        // Jika Jam Mulai == Jam Sekarang, maka Notif!
                        return startHour === currentHour;
                    });

                    // B. Cari Misi All Day (Hanya muncul sekali sehari)
                    const allDayTasks = tasks.filter(t => 
                        t.date === today && t.status === 'pending' && t.timeSlot === 'all'
                    );

                    let notifBody = [];
                    let notifTitle = "";

                    // Masukkan Misi Jam Ini ke Body Notif
                    if (slotTasks.length > 0) {
                        notifTitle = ` FASE JAM ${String(currentHour).padStart(2,'0')}:00`;
                        slotTasks.forEach(t => notifBody.push(` ${t.text}`));
                    }

                    // Logika All Day: Hanya muncul jika ini adalah notifikasi PERTAMA hari ini
                    // (Cek apakah tracker sebelumnya bukan tanggal hari ini)
                    const lastNotifDate = this.state.notifiedTracker.slot ? this.state.notifiedTracker.slot.split('-h')[0] : '';
                    
                    if (allDayTasks.length > 0 && lastNotifDate !== today) {
                        if (!notifTitle) notifTitle = " MISI HARIAN";
                        allDayTasks.forEach(t => notifBody.push(` [ALL] ${t.text}`));
                    }

                    // EKSEKUSI: Tampilkan Notif jika ada isinya
                    if (notifBody.length > 0) {
                        this.showNotification(notifTitle, notifBody.join("\n"));
                        this.sound.play('nav'); // Bunyi efek
                    }

                    // KUNCI: Update tracker agar jam ini tidak bunyi lagi
                    this.state.notifiedTracker.slot = currentNotifKey;
                }

                // --- BAGIAN 2: NOTIFIKASI HADIAH (WALLET CHECK) ---
                // Cek setiap detik ke-0 sampai ke-15 saja biar ringan
                if (now.getSeconds() < 15) { 
                    const rewards = Store.get('rewards');
                    
                    // Hitung Saldo Real-time
                    const { total } = Engine.calcPoints(tasks);
                    const settings = Store.get('settings');
                    const archivedSpent = settings.archivedSpent || 0;
                    
                    const allRedeemed = rewards.filter(r => r.status === 'redeemed');
                    const totalSpent = allRedeemed.reduce((acc, r) => acc + (r.cost || 0), 0) + archivedSpent;
                    const walletBalance = total - totalSpent;

                    // Cari hadiah yang bisa dibeli & belum dinotif
                    const claimableRewards = rewards.filter(r => 
                        r.status === 'active' && 
                        walletBalance >= r.cost &&
                        !this.state.notifiedTracker.rewards.includes(r.id)
                    );

                    if (claimableRewards.length > 0) {
                        const rNames = claimableRewards.map(r => r.name).join(", ");
                        this.showNotification(" REWARD UNLOCKED!", `Saldo cukup untuk: ${rNames}`);
                        this.sound.play('success');
                        
                        // Masukkan ke tracker
                        claimableRewards.forEach(r => this.state.notifiedTracker.rewards.push(r.id));
                    }
                }
            },
            // Fungsi Helper Baru untuk Memunculkan Notif (Support Service Worker jika ada)
            showNotification(title, body) {
                const options = {
                    body: body,
                    icon: "https://placehold.co/192x192/020617/06b6d4.png?text=WM",
                    badge: "https://placehold.co/96x96/020617/ffffff.png?text=W", // Icon kecil di status bar android
                    vibrate: [200, 100, 200],
                    tag: "wakemap-alert", // Agar notifikasi tidak menumpuk
                    renotify: true // Agar HP getar lagi walaupun notif lama belum ditutup
                };

                // Coba pakai Service Worker (Lebih kuat di Android)
                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, options);
                    });
                } else {
                    // Fallback ke notifikasi biasa
                    new Notification(title, options);
                }
            },
            navigate(view) { 
                this.state.view = view; 
                this.sound.play('nav');
                this.render(); 
            },
            
            setDifficulty(d) { 
                const el = document.getElementById('task-in');
                if(el) this.state.tempTaskInput = el.value;

                this.state.difficulty = d; 
                this.sound.play('click');
                this.render(); 
            },

            // --- ACTIONS ---
            initTask() {
                const input = document.getElementById('task-in');
                const text = input.value.trim();
                if (!text) { 
                    this.toast('Nama misi wajib diisi', 'error'); 
                    return; 
                }
                this.state.tempTask = { text, difficulty: this.state.difficulty };
                this.state.tempTaskInput = ''; 
                this.openModal();
                input.value = '';
                this.sound.play('click');
            },

            confirmTask(slotId) {
                if (!this.state.tempTask) return;
                const tasks = Store.get('tasks');
                tasks.push({
                    id: Utils.generateId(),
                    text: this.state.tempTask.text,
                    difficulty: this.state.tempTask.difficulty,
                    timeSlot: slotId,
                    date: Utils.getTomorrow(), 
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                Store.set('tasks', tasks);
                this.closeModal();
                this.sound.play('success');
                this.toast('Misi dijadwalkan besok', 'success');
                this.render();
            },

           // --- CARI BAGIAN INI DI DALAM Controller ---
            updateTask(id, status) {
                const tasks = Store.get('tasks');
                const t = tasks.find(x => x.id === id);
                if (t) {
                    t.status = status;
                    Store.set('tasks', tasks);
                    
                    if (status === 'completed') {
                        this.sound.play('success');
                        // BAGIAN AUTO-CLAIM YANG LAMA DIHAPUS, DIGANTI JADI SIMPEL SAJA
                    } else {
                        this.sound.play('error');
                    }
                    this.render();
                }
            },
            deleteTask(id) {
                if(confirm('Hapus misi ini?')) {
                    const tasks = Store.get('tasks').filter(t => t.id !== id);
                    Store.set('tasks', tasks);
                    this.sound.play('click');
                    this.toast('Misi dihapus', 'info');
                    this.render();
                } else {
                    this.render();
                }
            },

            saveRef() {
                const val = document.getElementById('ref-in').value.trim();
                if(val) {
                    const refs = Store.get('reflections');
                    const today = Utils.getISO();
                    const ex = refs.find(r => r.date === today);
                    if(ex) ex.text = val; else refs.push({ date: today, text: val });
                    Store.set('reflections', refs);
                    this.sound.play('success');
                    this.toast('Refleksi tersimpan', 'success');
                    this.render();
                }
            },

            // --- BLUEPRINT SYSTEM ---
           openBlueprintManager() {
                this.sound.play('click');
                const blueprints = Store.get('blueprints'); 
                
                const m = document.getElementById('modal-layer');
                
                // Helper untuk generate opsi jam 00-23
                const hourOptions = Array.from({length: 24}, (_, i) => `<option value="${i}">${String(i).padStart(2,'0')}:00</option>`).join('');

                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-md p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out] max-h-[85vh] flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">Blueprint System</h3>
                            <p class="text-slate-400 text-xs font-mono">Template Misi Rutin</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>

                    <!-- Create New Section -->
                    <div class="glass-card p-4 rounded-xl border border-white/10 mb-6 bg-slate-800/50">
                        <h4 class="text-xs font-bold text-neonCyan uppercase tracking-widest mb-3 flex items-center gap-2"><i data-lucide="plus-square" class="w-3 h-3"></i> Buat Template Baru</h4>
                        <div class="space-y-3">
                            <input id="bp-text" type="text" placeholder="Nama Rutinitas..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none placeholder:text-slate-600">
                            
                            <!-- Difficulty Buttons -->
                            <div class="flex gap-2">
                                <button type="button" onclick="App.controller.setTempBpDiff('easy')" id="bp-btn-easy" class="flex-1 py-2 rounded-lg text-[10px] font-bold border border-slate-700 text-slate-500 uppercase transition-all hover:bg-slate-700">Mudah</button>
                                <button type="button" onclick="App.controller.setTempBpDiff('medium')" id="bp-btn-medium" class="flex-1 py-2 rounded-lg text-[10px] font-bold border border-slate-700 text-slate-500 uppercase transition-all hover:bg-slate-700">Sedang</button>
                                <button type="button" onclick="App.controller.setTempBpDiff('hard')" id="bp-btn-hard" class="flex-1 py-2 rounded-lg text-[10px] font-bold border border-slate-700 text-slate-500 uppercase transition-all hover:bg-slate-700">Sulit</button>
                            </div>
                            
                            <!-- [BARU] Time Range Selectors -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Mulai Jam</label>
                                    <select id="bp-start" class="w-full bg-charcoal text-white rounded-lg px-3 py-2.5 text-xs border border-slate-700 focus:border-neonCyan outline-none font-mono">
                                        ${hourOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Selesai Jam</label>
                                    <select id="bp-end" class="w-full bg-charcoal text-white rounded-lg px-3 py-2.5 text-xs border border-slate-700 focus:border-neonCyan outline-none font-mono">
                                        ${Array.from({length: 24}, (_, i) => `<option value="${i+1}" ${i===0?'selected':''}>${String(i+1).padStart(2,'0')}:00</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <button onclick="App.controller.saveBlueprint()" class="w-full bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian py-3 rounded-lg text-xs font-bold uppercase tracking-widest shadow-lg transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Simpan Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i data-lucide="layers" class="w-4 h-4 text-slate-500"></i>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Daftar Blueprint</span>
                    </div>

                    <div class="overflow-y-auto custom-scroll flex-1 pr-1 space-y-3 pb-2">
                        ${blueprints.length === 0 ? '<div class="text-center py-8 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">Belum ada blueprint tersimpan.</div>' : 
                        blueprints.map(bp => {
                            const d = Config.DIFFICULTY[bp.difficulty];
                            return `
                            <div class="p-4 rounded-xl flex items-center justify-between border border-slate-700 bg-slate-800/30 hover:border-slate-500 transition-all group">
                                <div class="flex-1 pr-3">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="text-[8px] font-mono font-bold text-slate-300 bg-surface px-1.5 py-0.5 rounded border border-white/5">${bp.customLabel || 'ALL DAY'}</span>
                                        <span class="text-[8px] font-bold border px-1.5 py-0.5 rounded uppercase ${d.color} ${d.border} bg-white/5">${d.label}</span>
                                    </div>
                                    <p class="text-sm text-white font-medium">${bp.text}</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="App.controller.useBlueprint('${bp.id}')" class="p-2 rounded-lg bg-neonCyan text-obsidian hover:bg-white font-bold shadow-lg transition-transform active:scale-95" title="Pakai Template"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                    <button onclick="App.controller.deleteBlueprint('${bp.id}')" class="p-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-500 hover:text-neonRed hover:border-neonRed transition-colors active:scale-95" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
                
                this.state.tempBlueprintDiff = 'easy';
                this.renderBlueprintDiffBtns();
            },

            setTempBpDiff(d) {
                this.state.tempBlueprintDiff = d;
                this.renderBlueprintDiffBtns();
                this.sound.play('click');
            },

            renderBlueprintDiffBtns() {
                const diffs = ['easy', 'medium', 'hard'];
                diffs.forEach(d => {
                    const btn = document.getElementById(`bp-btn-${d}`);
                    if(!btn) return;
                    const c = Config.DIFFICULTY[d];
                    if (this.state.tempBlueprintDiff === d) {
                        btn.className = `flex-1 py-2 rounded-lg text-[10px] font-bold border uppercase transition-all bg-white/10 text-white shadow-[0_0_10px_currentColor] ${c.border}`;
                        btn.style.color = c.hex;
                    } else {
                        btn.className = `flex-1 py-2 rounded-lg text-[10px] font-bold border border-slate-700 text-slate-500 uppercase transition-all hover:bg-slate-700`;
                        btn.style.color = '';
                    }
                });
            },

           saveBlueprint() {
                const text = document.getElementById('bp-text').value.trim();
                const diff = this.state.tempBlueprintDiff;
                
                const start = parseInt(document.getElementById('bp-start').value);
                const end = parseInt(document.getElementById('bp-end').value);

                if(!text) { this.toast('Nama blueprint wajib diisi', 'error'); return; }
                if(end <= start) { this.toast('Jam selesai harus lebih besar dari mulai', 'error'); return; }

                const bps = Store.get('blueprints');
                const timeLabel = `${String(start).padStart(2,'0')}:00 - ${String(end).padStart(2,'0')}:00`;

                bps.push({
                    id: Utils.generateId(),
                    text: text,
                    difficulty: diff,
                    timeSlot: 'custom', // Tandai sebagai custom
                    customStart: start,
                    customEnd: end,
                    customLabel: timeLabel
                });
                Store.set('blueprints', bps);
                this.sound.play('success');
                this.toast('Blueprint tersimpan', 'success');
                this.openBlueprintManager(); 
            },

            deleteBlueprint(id) {
                if(confirm('Hapus blueprint ini?')) {
                    const bps = Store.get('blueprints').filter(b => b.id !== id);
                    Store.set('blueprints', bps);
                    this.sound.play('click');
                    this.openBlueprintManager(); 
                }
            },

          useBlueprint(id) {
                const bps = Store.get('blueprints');
                const bp = bps.find(b => b.id === id);
                if(bp) {
                    const tasks = Store.get('tasks');
                    tasks.push({
                        id: Utils.generateId(),
                        text: bp.text,
                        difficulty: bp.difficulty,
                        timeSlot: bp.timeSlot || 'custom',
                        
                        // [PENTING] Transfer data waktu custom
                        customStart: bp.customStart,
                        customEnd: bp.customEnd,
                        customLabel: bp.customLabel,

                        date: Utils.getTomorrow(),
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                    Store.set('tasks', tasks);
                    this.sound.play('success');
                    this.toast('Misi ditambahkan untuk besok!', 'success');
                    this.closeModal();
                    this.render();
                }
            },

            // --- GOAL & SNAPSHOT SYSTEM ---
            openGoalModal(goalId = null) {
                this.sound.play('click');
                const goals = Store.get('goals') || [];
                const goal = goalId ? goals.find(g => g.id === goalId) : null;
                
                // Set temp state
                this.state.tempGoal = goal ? { ...goal } : { id: null, title: '', target: '', category: 'lainnya', type: 'progressive', rankIndex: 0 };

                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">${goalId ? 'Edit Target' : 'Target Baru'}</h3>
                            <p class="text-slate-400 text-xs font-mono">Tentukan fokus jangka panjangmu.</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Goal Type Selection -->
                        <div class="flex bg-surface p-1 rounded-lg border border-slate-700">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="goalType" value="progressive" class="peer hidden" ${this.state.tempGoal.type !== 'single' ? 'checked' : ''} onchange="App.controller.toggleGoalType('progressive')">
                                <div class="py-2 text-[10px] font-bold text-slate-400 peer-checked:bg-slate-700 peer-checked:text-neonCyan rounded-md transition-all">BERJENJANG (Level Up)</div>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="goalType" value="single" class="peer hidden" ${this.state.tempGoal.type === 'single' ? 'checked' : ''} onchange="App.controller.toggleGoalType('single')">
                                <div class="py-2 text-[10px] font-bold text-slate-400 peer-checked:bg-slate-700 peer-checked:text-neonGold rounded-md transition-all">SEKALI JADI (One-Shot)</div>
                            </label>
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Nama Target</label>
                            <input id="goal-title" type="text" value="${this.state.tempGoal.title}" placeholder="Misal: Berhenti Main Game" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>
                        
                        <div id="target-input-container" style="${this.state.tempGoal.type === 'single' ? 'display:none' : ''}">
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Target Awal</label>
                            <input id="goal-target" type="text" value="${this.state.tempGoal.target}" placeholder="Misal: 3 Hari / Semester 1" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>

                        <div id="rank-input-container"> <!-- Always Visible now based on request logic adjustment, contextually labelled -->
                            <label id="rank-label" class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">${this.state.tempGoal.type === 'single' ? 'Pilih Pangkat (Difficulty)' : 'Pilih Pangkat Awal (Start Tier)'}</label>
                            <select id="goal-rank" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none font-mono">
                                ${Config.TIERS.map((t, idx) => `<option value="${idx}" ${this.state.tempGoal.rankIndex === idx ? 'selected' : ''}>${t.code} - ${t.name}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Kategori</label>
                            <select id="goal-cat" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                                ${Config.GOAL_CATEGORIES.map(c => `<option value="${c.id}" ${this.state.tempGoal.category === c.id ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="App.controller.saveGoal()" class="w-full bg-neonCyan text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg flex justify-center items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Target</button>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            toggleGoalType(type) {
                const targetContainer = document.getElementById('target-input-container');
                const rankLabel = document.getElementById('rank-label');
                
                if (type === 'single') {
                    targetContainer.style.display = 'none';
                    rankLabel.innerText = 'Pilih Pangkat (Difficulty)';
                } else {
                    targetContainer.style.display = 'block';
                    rankLabel.innerText = 'Pilih Pangkat Awal (Start Tier)';
                }
            },

            saveGoal() {
                const title = document.getElementById('goal-title').value.trim();
                const type = document.querySelector('input[name="goalType"]:checked').value;
                const target = type === 'progressive' ? document.getElementById('goal-target').value.trim() : title;
                const cat = document.getElementById('goal-cat').value;
                const rankIndex = parseInt(document.getElementById('goal-rank').value);

                if(!title || (type === 'progressive' && !target)) { this.toast('Semua data wajib diisi', 'error'); return; }

                let goals = Store.get('goals') || [];
                
                if (this.state.tempGoal.id) {
                    const idx = goals.findIndex(g => g.id === this.state.tempGoal.id);
                    if (idx !== -1) {
                        goals[idx] = { ...goals[idx], title, currentTarget: target, category: cat, type, rankIndex };
                    }
                } else {
                    goals.push({
                        id: Utils.generateId(),
                        title: title,
                        currentTarget: target,
                        category: cat,
                        type: type,
                        rankIndex: rankIndex,
                        status: 'active',
                        createdAt: Utils.getISO()
                    });
                }
                
                Store.set('goals', goals);
                this.sound.play('success');
                this.toast('Target Aktif tersimpan!', 'success');
                this.closeModal();
                this.render();
            },

            deleteGoal(id) {
                if(confirm('Hapus target ini? (Snapshot di Hall of Fame tidak akan hilang)')) {
                    const goals = Store.get('goals') || [];
                    const newGoals = goals.filter(g => g.id !== id);
                    Store.set('goals', newGoals);
                    this.sound.play('click');
                    this.render();
                }
            },

            openSnapshotModal(goalId) {
                this.sound.play('click');
                const goals = Store.get('goals') || [];
                const goal = goals.find(g => g.id === goalId);
                if (!goal) return;

                const goalType = goal.type || 'progressive'; 

                // Calculate Tier
                let calculatedTierIndex = goal.rankIndex || 0; // Base rank
                if (goalType === 'progressive') {
                    const achs = Store.get('achievements').filter(a => a.goalId === goalId);
                    const count = achs.length;
                    // Add accumulated progress to base rank
                    calculatedTierIndex = Math.min(calculatedTierIndex + count, Config.TIERS.length - 1);
                }

                this.state.tempSnapshot = { goalId: goal.id, milestone: goal.currentTarget, isFinal: false, nextTarget: '', tierIndex: calculatedTierIndex };

                const m = document.getElementById('modal-layer');
                let modalContent = '';

                const tierInfo = Config.TIERS[calculatedTierIndex];

                if (goalType === 'progressive') {
                    modalContent = `
                    <div class="mb-4 text-center">
                        <div class="font-display text-4xl mb-1 transition-all duration-500" style="color:${tierInfo.barColor}; text-shadow: 0 0 15px ${tierInfo.barColor};">
                            ${tierInfo.code}
                        </div>
                        <div class="text-[10px] text-white font-bold tracking-[0.2em] uppercase opacity-80">${tierInfo.name}</div>
                        <div class="text-[9px] text-neonGold mt-1 bg-black/30 px-2 py-0.5 rounded-full inline-block border border-neonGold/30">BONUS: +${Utils.formatCurrency(tierInfo.bonus)} PTS</div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block flex justify-between">
                                <span>Pencapaian Saat Ini (Locked)</span>
                                <i data-lucide="lock" class="w-3 h-3 text-slate-500"></i>
                            </label>
                            <input type="text" value="${goal.currentTarget}" disabled class="w-full bg-slate-900 text-neonCyan font-bold rounded-lg px-4 py-3 text-sm border border-slate-800 cursor-not-allowed">
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Target Berikutnya (Untuk Lanjut)</label>
                            <input id="snap-next" type="text" placeholder="Misal: Semester 2..." class="w-full bg-surface text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>

                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button onclick="App.controller.saveSnapshot('final')" class="p-3 rounded-xl border border-neonRed/30 bg-neonRed/10 text-neonRed hover:bg-neonRed hover:text-white transition-all flex flex-col items-center justify-center gap-1 group">
                                <i data-lucide="flag" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold">TAMAT / FINAL</span>
                            </button>
                            <button onclick="App.controller.saveSnapshot('continue')" class="p-3 rounded-xl bg-neonCyan text-obsidian hover:bg-white transition-all flex flex-col items-center justify-center gap-1 shadow-lg font-bold group">
                                <i data-lucide="arrow-up-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px]">SIMPAN & LANJUT</span>
                            </button>
                        </div>
                    </div>`;
                } else {
                    modalContent = `
                    <div class="mb-6 text-center">
                        <div class="font-display text-6xl mb-2 transition-all duration-500" style="color:${tierInfo.barColor}; text-shadow: 0 0 20px ${tierInfo.barColor};">
                            ${tierInfo.code}
                        </div>
                        <div class="text-xs text-white font-bold tracking-[0.3em] uppercase opacity-80 mb-4">${tierInfo.name}</div>
                        <div class="text-[10px] text-neonGold mt-2 bg-black/30 px-3 py-1 rounded-full inline-block border border-neonGold/30 font-bold">BONUS: +${Utils.formatCurrency(tierInfo.bonus)} PTS</div>
                        <p class="text-slate-400 text-xs px-4 mt-4">Anda akan menyimpan "<strong>${goal.title}</strong>" ke Hall of Fame sebagai pencapaian Rank ${tierInfo.code}.</p>
                    </div>
                    <button onclick="App.controller.saveSnapshot('final')" class="w-full bg-neonGold text-obsidian px-4 py-4 rounded-xl font-bold hover:bg-white transition-colors shadow-[0_0_20px_rgba(245,158,11,0.3)] flex justify-center items-center gap-2 tracking-widest">
                        <i data-lucide="trophy" class="w-5 h-5"></i> KLAIM KEJAYAAN
                    </button>`;
                }

                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">Checkpoint Protocol</h3>
                            <p class="text-slate-400 text-xs font-mono">Abadikan momen pencapaian ini.</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    ${modalContent}
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            saveSnapshot(action) {
                const goalId = this.state.tempSnapshot.goalId;
                
                let goals = Store.get('goals') || [];
                const goalIndex = goals.findIndex(g => g.id === goalId);
                if (goalIndex === -1) return;
                const goal = goals[goalIndex];
                const milestone = goal.currentTarget; 

                const goalType = goal.type || 'progressive';
                let nextTarget = '';
                
                if (goalType === 'progressive' && action === 'continue') {
                    nextTarget = document.getElementById('snap-next').value.trim();
                    if (!nextTarget) {
                        this.toast('Target selanjutnya wajib diisi untuk lanjut!', 'error');
                        return;
                    }
                }

                let achs = Store.get('achievements');
                const isDuplicate = achs.some(a => a.goalId === goalId && a.title === milestone); 
                if (isDuplicate) {
                    this.toast('Checkpoint ini sudah ada!', 'error');
                    return;
                }

                const isFinal = (action === 'final');
                const tierIdx = this.state.tempSnapshot.tierIndex;
                const tier = Config.TIERS[tierIdx];

                // 1. SAVE ACHIEVEMENT
                achs.push({
                    id: Utils.generateId(),
                    title: milestone, 
                    parentTitle: goal.title, 
                    tierIndex: tierIdx, 
                    category: goal.category,
                    dateUnlocked: Utils.getISO(),
                    isFinal: isFinal,
                    goalId: goalId
                });
                Store.set('achievements', achs);

                // 2. INJECT BONUS POINTS (AS HIDDEN COMPLETED TASK)
                if (tier.bonus > 0) {
                    const tasks = Store.get('tasks');
                    tasks.push({
                        id: Utils.generateId(),
                        text: `Hall of Fame Bonus: ${goal.title} (${tier.code})`,
                        difficulty: 'easy', // Placeholder
                        pts: tier.bonus, // Explicit Points
                        type: 'bonus', // Special Type
                        timeSlot: 'all',
                        date: Utils.getISO(),
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    });
                    Store.set('tasks', tasks);
                }

                // 3. UPDATE GOAL STATE
                if (isFinal) {
                    goals = goals.filter(g => g.id !== goalId);
                } else if (nextTarget) {
                    goals[goalIndex].currentTarget = nextTarget;
                }

                Store.set('goals', goals);

                this.sound.play('success');
                this.toast(`Snapshot tersimpan! +${tier.bonus} PTS ditambahkan!`, 'success');
                this.closeModal();
                this.render();
            },

            deleteAchievement(id) {
                const achs = Store.get('achievements').filter(a => a.id !== id);
                Store.set('achievements', achs);
                this.sound.play('click');
                this.toast('Snapshot dihapus', 'info');
                this.closeModal(); 
                this.render();
            },

            // New: Show Stack Details
            openStackDetails(goalId) {
                this.sound.play('click');
                const achs = Store.get('achievements').filter(a => a.goalId === goalId);
                achs.sort((a,b) => new Date(b.dateUnlocked) - new Date(a.dateUnlocked));
                
                if (achs.length === 0) return;
                const parentTitle = achs[0].parentTitle || "Pencapaian";

                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out] max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-white">${parentTitle}</h3>
                            <p class="text-slate-400 text-xs font-mono">Riwayat Perjalanan</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="overflow-y-auto custom-scroll flex-1 pr-1 space-y-3">
                        ${achs.map(ach => {
                            const tier = Config.TIERS[ach.tierIndex] || Config.TIERS[0];
                            return `
                            <div class="glass-card p-3 rounded-xl flex items-center justify-between border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="font-display text-2xl w-10 text-center" style="color:${tier.barColor}; text-shadow:0 0 10px ${tier.barColor}">${tier.code}</div>
                                    <div>
                                        <div class="text-sm font-bold text-white">${ach.title}</div>
                                        <div class="text-[10px] text-slate-500 font-mono">${Utils.formatDate(ach.dateUnlocked)}</div>
                                        <div class="text-[8px] text-neonGold mt-0.5">+${Utils.formatCurrency(tier.bonus)} Pts</div>
                                    </div>
                                </div>
                                <button onclick="if(confirm('Hapus entry ini?')){App.controller.deleteAchievement('${ach.id}')}" class="text-slate-600 hover:text-neonRed p-2"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            // --- FINANCE & REWARD ACTIONS ---
            selectMode(id) {
                const incEl = document.getElementById('income-in');
                const allocEl = document.getElementById('alloc-in');
                
                if(incEl) this.state.tempIncome = incEl.value;
                if(allocEl) this.state.tempAlloc = allocEl.value;

                this.state.tempMode = id;
                this.sound.play('click');
                this.render();
            },

            saveMonthlyConfig() {
                const incomeIn = document.getElementById('income-in').value;
                const allocIn = document.getElementById('alloc-in').value;
                const modeId = this.state.tempMode;
                
                if(!incomeIn || incomeIn <= 0) { this.toast('Nominal gaji tidak valid', 'error'); return; }
                if(!modeId) { this.toast('Pilih mode operasi', 'error'); return; }
                
                const allocation = allocIn ? parseFloat(allocIn) : 0.2;

                const mode = Config.PRODUCTIVITY_MODES.find(m => m.id === modeId);
                const finance = Store.get('finance'); 
                const monthKey = Utils.getMonthKey(Utils.getISO());
                const newFinance = finance.filter(f => f.month !== monthKey);
                newFinance.push({ 
                    month: monthKey, 
                    amount: parseInt(incomeIn), 
                    targetPts: mode.pts, 
                    modeId: modeId,
                    allocation: allocation 
                });
                
                Store.set('finance', newFinance);
                this.state.tempIncome = ''; 
                this.state.tempAlloc = '';
                this.state.tempMode = null;
                
                this.sound.play('success');
                this.toast(`Protokol: ${mode.label.toUpperCase()} diaktifkan!`, 'success');
                this.render();
            },

            initReward() {
                const nameIn = document.getElementById('rew-name').value.trim();
                if(!nameIn) { this.toast('Nama hadiah wajib diisi', 'error'); return; }
                
                this.state.tempReward = { name: nameIn, hasPrice: false, price: 0, cost: 0, recs: null };
                this.state.rewardStep = 1;
                this.sound.play('click');
                this.render();
            },

            setRewardHasPrice(hasPrice) {
                this.state.tempReward.hasPrice = hasPrice;
                this.state.rewardStep = 2;
                this.sound.play('click');
                this.render();
            },

            calcRewardRecs() {
                const priceIn = document.getElementById('rew-price').value;
                if (!priceIn || priceIn <= 0) {
                    this.state.tempReward.recs = null;
                    const c = document.getElementById('rec-container');
                    if(c) c.innerHTML = '';
                    return;
                }

                const financeData = Store.get('finance');
                const curMonthKey = Utils.getMonthKey(Utils.getISO());
                const myFinance = financeData.find(f => f.month === curMonthKey);

                if (myFinance) {
                    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    
                    const allocation = myFinance.allocation || 0.2; 
                    const monthlyBudget = myFinance.amount * allocation;
                    const dailyBudget = monthlyBudget / daysInMonth;
                    
                    const dailyTarget = myFinance.targetPts || 10;
                    
                    const valPerPoint = Math.max(1, Math.round(dailyBudget / dailyTarget)); 
                    const price = parseInt(priceIn);
                    
                    const normalPts = Math.ceil(price / valPerPoint);
                    const hardPts = Math.ceil(normalPts * 1.5);

                    const recContainer = document.getElementById('rec-container');
                    if (recContainer) {
                        recContainer.innerHTML = `
                        <div class="flex gap-2 mt-2 animate-[fadeIn_0.3s]">
                            <button onclick="App.controller.applyRec(${normalPts})" class="flex-1 bg-surface border border-slate-600 hover:border-neonCyan p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Normal (Fair)</span>
                                <span class="block text-neonCyan font-bold font-mono text-sm">${normalPts} Pts</span>
                            </button>
                            <button onclick="App.controller.applyRec(${hardPts})" class="flex-1 bg-surface border border-slate-600 hover:border-neonPurple p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Sulit (Hemat)</span>
                                <span class="block text-neonPurple font-bold font-mono text-sm">${hardPts} Pts</span>
                            </button>
                        </div>`;
                    }
                } else {
                      const recContainer = document.getElementById('rec-container');
                      if(recContainer) recContainer.innerHTML = `<p class="text-[10px] text-neonRed text-center mt-2">Belum ada data keuangan bulan ini. Cek Menu PETA.</p>`;
                }
            },

            applyRec(pts) {
                const costInput = document.getElementById('rew-cost');
                if (costInput) costInput.value = pts;
                this.sound.play('click'); 
            },

            resetRewardForm() {
                this.state.rewardStep = 0;
                this.state.tempReward = { name: '', hasPrice: false, price: 0, cost: 0, recs: null };
                this.sound.play('click');
                this.render();
            },

            saveReward() {
                const costIn = document.getElementById('rew-cost').value;
                if(!costIn || costIn <= 0) { this.toast('Target poin wajib diisi', 'error'); return; }
                
                let priceVal = 0;
                if(this.state.tempReward.hasPrice) {
                    const priceIn = document.getElementById('rew-price').value;
                    if(!priceIn || priceIn <= 0) { this.toast('Harga nominal wajib diisi', 'error'); return; }
                    priceVal = parseInt(priceIn);
                }

                const r = Store.get('rewards');
                r.push({
                    id: Utils.generateId(),
                    name: this.state.tempReward.name,
                    cost: parseInt(costIn),
                    price: priceVal,
                    status: 'active',
                    redeemedDate: null
                });
                Store.set('rewards', r);
                this.sound.play('success');
                this.toast('Target ditambahkan', 'success');
                this.resetRewardForm();
            },

            delReward(id) {
                if(confirm('Hapus target?')) {
                    const r = Store.get('rewards').filter(x => x.id !== id);
                    Store.set('rewards', r);
                    this.sound.play('click');
                    this.render();
                }
            },

            // --- TAMBAHKAN FUNGSI INI DI DALAM Controller ---
            claimReward(id) {
                const rewards = Store.get('rewards');
                const reward = rewards.find(r => r.id === id);
                if (!reward) return;

                // Hitung Saldo Global (Untuk Pengecekan)
                const tasks = Store.get('tasks');
                const { total } = Engine.calcPoints(tasks); // Total Poin Seumur Hidup
                
                const allRedeemed = rewards.filter(r => r.status === 'redeemed');
               // Tambahkan archivedSpent juga disini
                const settings = Store.get('settings');
                const archivedSpent = settings.archivedSpent || 0;

                const totalSpent = allRedeemed.reduce((acc, r) => acc + (r.cost || 0), 0) + archivedSpent;
                const walletBalance = total - totalSpent;

                if (walletBalance >= reward.cost) {
                    if(confirm(`Klaim hadiah "${reward.name}" seharga ${reward.cost} Poin?\nSisa Poin Anda akan berkurang.`)) {
                        reward.status = 'redeemed';
                        reward.redeemedDate = Utils.getISO(); 
                        Store.set('rewards', rewards);
                        this.sound.play('success');
                        this.toast(`Berhasil klaim: ${reward.name}`, 'success');
                        this.render();
                    }
                } else {
                    this.toast('Poin tidak cukup!', 'error');
                    this.sound.play('error');
                }
            },

            // New: Reset Redemeed logic if balance is buggy negative due to previous error
            resetRedeemedRewards() {
                 if(confirm('Fitur ini akan mereset status semua hadiah yang sudah diklaim menjadi aktif kembali agar poin Anda kembali normal. Lanjutkan?')) {
                     const rewards = Store.get('rewards');
                     rewards.forEach(r => {
                         if(r.status === 'redeemed') {
                             r.status = 'active';
                             r.redeemedDate = null;
                         }
                     });
                     Store.set('rewards', rewards);
                     this.toast('Riwayat belanja di-reset.', 'success');
                     window.location.reload();
                 }
            },

            navMonth(offset) {
                const [y, m] = this.state.histMonth.split('-');
                const targetDate = new Date(y, parseInt(m) - 1 + offset);
                
                const now = new Date();
                const limitDate = new Date(now.getFullYear() - 2, now.getMonth(), 1);
                
                if (targetDate < limitDate) {
                    this.toast('Batas riwayat 2 tahun tercapai', 'info');
                    this.sound.play('error');
                    return;
                }

                this.state.histMonth = Utils.getISO(targetDate).slice(0, 7);
                this.state.histDate = null;
                this.sound.play('click');
                this.render();
            },

            setDate(d) {
                this.state.histDate = d;
                this.sound.play('click');
                this.render();
            },

            // --- SETTINGS ---
            openSettings() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                const isMuted = this.sound.muted;
                const notifPerm = ("Notification" in window) ? Notification.permission : 'denied';
                const settings = Store.get('settings');
                const currentTheme = settings.theme || 'default';
                
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">Pengaturan</h3>
                            <p class="text-slate-400 text-xs font-mono">Konfigurasi sistem.</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto custom-scroll pr-1">
                        
                        <!-- Theme Selector -->
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Tema Visual</label>
                            <div class="grid grid-cols-3 gap-2">
                                ${Config.THEMES.map(t => {
                                    const active = currentTheme === t.id;
                                    return `
                                    <button onclick="App.controller.setTheme('${t.id}')" class="p-2 rounded-xl border ${active ? 'border-neonCyan bg-white/5' : 'border-slate-700 bg-slate-800'} flex flex-col items-center gap-2 group transition-all">
                                        <div class="w-full h-8 rounded-lg ${t.preview} shadow-lg relative overflow-hidden">
                                            ${active ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                        </div>
                                        <span class="text-[9px] font-bold ${active ? 'text-white' : 'text-slate-400'}">${t.label}</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Sound Toggle -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-surface border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-neonPurple/10 rounded-lg text-neonPurple"><i data-lucide="${isMuted ? 'volume-x' : 'volume-2'}" class="w-5 h-5"></i></div>
                                <div>
                                    <span class="block text-sm font-bold text-white">Suara Efek (SFX)</span>
                                    <span class="block text-[10px] text-slate-400">${isMuted ? 'Nonaktif' : 'Aktif'}</span>
                                </div>
                            </div>
                            <button onclick="App.controller.toggleSound()" class="w-12 h-6 rounded-full transition-colors relative ${isMuted ? 'bg-slate-600' : 'bg-neonGreen'}">
                                <div class="absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${isMuted ? 'left-1' : 'left-7'}"></div>
                            </button>
                        </div>

                        <!-- Notification Toggle -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-surface border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-neonGold/10 rounded-lg text-neonGold"><i data-lucide="bell" class="w-5 h-5"></i></div>
                                <div>
                                    <span class="block text-sm font-bold text-white">Notifikasi Misi</span>
                                    <span class="block text-[10px] text-slate-400">${notifPerm === 'granted' ? 'Aktif (System)' : 'Nonaktif'}</span>
                                </div>
                            </div>
                            ${notifPerm === 'granted' 
                                ? `<span class="text-[10px] text-neonGreen font-bold px-2">ON</span>` 
                                : `<button onclick="App.controller.requestPermission()" class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-[10px] hover:bg-neonGold hover:text-obsidian transition-colors">Aktifkan</button>`
                            }
                        </div>

                        <div class="space-y-2 pt-2">
                            <button onclick="App.controller.exportData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonCyan transition-all group">
                                <div class="p-2 bg-neonCyan/10 rounded-lg text-neonCyan"><i data-lucide="download" class="w-5 h-5"></i></div>
                                <div class="text-left">
                                    <span class="block text-sm font-bold text-white group-hover:text-neonCyan transition-colors">Backup Data</span>
                                    <span class="block text-[10px] text-slate-400">Unduh data ke file JSON</span>
                                </div>
                            </button>
                            
                            <button onclick="App.controller.importData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonGreen transition-all group">
                                <div class="p-2 bg-neonGreen/10 rounded-lg text-neonGreen"><i data-lucide="upload" class="w-5 h-5"></i></div>
                                <div class="text-left">
                                    <span class="block text-sm font-bold text-white group-hover:text-neonGreen transition-colors">Restore Data</span>
                                    <span class="block text-[10px] text-slate-400">Pulihkan dari file JSON</span>
                                </div>
                            </button>
                            
                            <button onclick="if(confirm('Yakin ingin menghapus SEMUA data? Aksi ini tidak bisa dibatalkan.')) { localStorage.clear(); location.reload(); }" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonRed transition-all group mt-6">
                                <div class="p-2 bg-neonRed/10 rounded-lg text-neonRed"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                                <div class="text-left">
                                    <span class="block text-sm font-bold text-white group-hover:text-neonRed transition-colors">Reset Total</span>
                                    <span class="block text-[10px] text-slate-400">Hapus semua progress</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            toggleSound() {
                const newState = !this.sound.muted;
                this.sound.setMuted(newState);
                this.openSettings(); 
                if (!newState) this.sound.play('click');
            },

            exportData() {
                this.sound.play('click');
                const data = {
                    tasks: Store.get('tasks'),
                    rewards: Store.get('rewards'),
                    achievements: Store.get('achievements'), 
                    goals: Store.get('goals'), 
                    blueprints: Store.get('blueprints'), 
                    reflections: Store.get('reflections'),
                    finance: Store.get('finance'),
                    settings: Store.get('settings')
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wakemap_backup_${Utils.getISO()}.json`;
                a.click();
                this.toast('Data berhasil di-backup!', 'success');
            },

            importData() {
                this.sound.play('click');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.tasks) Store.set('tasks', data.tasks);
                            if (data.rewards) Store.set('rewards', data.rewards);
                            if (data.achievements) Store.set('achievements', data.achievements); 
                            if (data.goals) Store.set('goals', data.goals); 
                            if (data.blueprints) Store.set('blueprints', data.blueprints); 
                            if (data.reflections) Store.set('reflections', data.reflections);
                            if (data.finance) Store.set('finance', data.finance);
                            if (data.settings) Store.set('settings', data.settings);
                            this.sound.play('success');
                            this.toast('Data berhasil dipulihkan!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } catch (err) {
                            this.sound.play('error');
                            this.toast('File backup tidak valid', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // --- UI HELPERS ---
            toast(msg, type='info') {
                if (type === 'error') this.sound.play('error');
                
                const el = document.getElementById('toast-layer');
                const div = document.createElement('div');
                const cls = { success:'border-neonGreen text-neonGreen', error:'border-neonRed text-neonRed', info:'border-neonCyan text-neonCyan' };
                const ico = { success:'check-circle', error:'alert-circle', info:'info' };
                div.className = `toast-msg border-l-4 ${cls[type]}`;
                div.innerHTML = `<i data-lucide="${ico[type]}" class="w-5 h-5"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                el.appendChild(div);
                lucide.createIcons();
                setTimeout(() => { div.style.animation = 'toastExit 0.4s forwards'; setTimeout(()=>div.remove(), 400); }, 3000);
            },

         openModal() {
                this.sound.play('click');
                this.state.tempTimeRange = { start: null, end: null };

                const m = document.getElementById('modal-layer');
                
                // GENERATE 25 TOMBOL (00 - 24)
                let gridHtml = '';
                for (let i = 0; i <= 24; i++) {
                    const label = i === 24 ? "24:00" : String(i).padStart(2,'0') + ":00";
                    // Tombol 24 kita bedakan sedikit warnanya
                    const isLast = i === 24;
                    
                    gridHtml += `
                        <button id="slot-btn-${i}" onclick="App.controller.selectTimeSlot(${i})" class="glass-card p-1 rounded-lg border ${isLast ? 'border-neonRed/30' : 'border-slate-700'} hover:bg-slate-700 text-center transition-all flex flex-col items-center justify-center min-h-[40px] ${isLast ? 'col-span-4 mt-2 bg-slate-800' : ''}">
                            <span class="${isLast ? 'text-neonRed' : 'text-slate-400'} font-mono font-bold text-xs pointer-events-none">${label}</span>
                            ${isLast ? '<span class="text-[8px] text-slate-500 uppercase">Batas Akhir (Midnight)</span>' : ''}
                        </button>
                    `;
                }

                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">Time Protocol</h3>
                            <p id="time-selection-status" class="text-slate-400 text-xs font-mono">Pilih JAM MULAI...</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.controller.resetTimeSelection()" class="text-xs font-bold text-neonRed border border-neonRed/30 px-3 py-1 rounded-lg hover:bg-neonRed hover:text-white transition-colors">ULANG</button>
                            <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <!-- GRID 00 - 24 -->
                    <div class="grid grid-cols-4 gap-2 h-64 overflow-y-auto custom-scroll pr-1 pb-2 mb-4">
                        ${gridHtml}
                    </div>

                    <!-- TOMBOL AKSI -->
                    <div class="flex gap-2">
                        <button onclick="App.controller.selectTimeSlot('all')" class="flex-1 border border-neonPurple/50 text-neonPurple p-3 rounded-xl font-bold text-xs hover:bg-neonPurple hover:text-white transition-all">
                            ALL DAY
                        </button>
                        <button id="btn-confirm-time" onclick="App.controller.submitTimeRange()" disabled class="flex-[2] bg-slate-800 text-slate-500 p-3 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 cursor-not-allowed">
                            PILIH WAKTU DULU
                        </button>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },
          resetTimeSelection() {
                this.sound.play('click');
                this.state.tempTimeRange = { start: null, end: null };
                this.updateTimeGridUI();
            },
           selectTimeSlot(val) {
                this.sound.play('click');
                
                if (val === 'all') {
                    this.state.tempTimeRange = { start: 0, end: 24, isAll: true };
                    this.submitTimeRange();
                    return;
                }

                let { start, end } = this.state.tempTimeRange;

                // PROTEKSI: Angka 24 tidak boleh jadi START
                if (start === null && val === 24) {
                    this.toast("Jam 24:00 hanya untuk waktu selesai.", "error");
                    return;
                }

                // SKENARIO 1: RESET (Jika klik tombol start yang sama)
                if (start === val && end === null) {
                    this.resetTimeSelection();
                    return;
                }

                // SKENARIO 2: PILIH START
                if (start === null || val < start) {
                    this.state.tempTimeRange = { start: val, end: null }; 
                } 
                // SKENARIO 3: PILIH END
                else if (val > start) {
                    // Logic Normal: Start 00, Klik 01 -> End 01. Durasi 1 Jam.
                    // Logic Akhir: Start 23, Klik 24 -> End 24. Durasi 1 Jam.
                    this.state.tempTimeRange = { start: start, end: val, isAll: false };
                }

                this.updateTimeGridUI();
            },

          updateTimeGridUI() {
                const range = this.state.tempTimeRange;
                const statusEl = document.getElementById('time-selection-status');
                const btnConfirm = document.getElementById('btn-confirm-time');

                // Loop sampai 24 (Total 25 Tombol)
                for (let i = 0; i <= 24; i++) {
                    const btn = document.getElementById(`slot-btn-${i}`);
                    if (!btn) continue;
                    
                    const isLast = i === 24;
                    // Style Default
                    let btnClass = `glass-card p-1 rounded-lg border ${isLast ? 'border-neonRed/30' : 'border-slate-700'} hover:bg-slate-700 text-center transition-all flex flex-col items-center justify-center min-h-[40px] ${isLast ? 'col-span-4 mt-2 bg-slate-800' : ''}`;
                    let textClass = `${isLast ? 'text-neonRed' : 'text-slate-400'} font-mono font-bold text-xs pointer-events-none`;

                    if (range.start !== null) {
                        // TOMBOL START
                        if (i === range.start) {
                            if (range.end === null) {
                                btnClass = "bg-neonGold text-obsidian shadow-[0_0_10px_rgba(245,158,11,0.5)] p-1 rounded-lg border border-neonGold text-center transition-all flex flex-col items-center justify-center min-h-[40px] animate-pulse";
                                textClass = "text-obsidian font-mono font-bold text-xs pointer-events-none";
                            } else {
                                btnClass = "bg-neonCyan text-obsidian p-1 rounded-lg border border-neonCyan text-center transition-all flex flex-col items-center justify-center min-h-[40px]";
                                textClass = "text-obsidian font-mono font-bold text-xs pointer-events-none";
                            }
                        }
                        // RANGE TENGAH
                        else if (range.end !== null && i > range.start && i < range.end) {
                            btnClass = "bg-neonCyan/20 text-white p-1 rounded-lg border border-neonCyan/50 text-center transition-all flex flex-col items-center justify-center min-h-[40px]";
                            textClass = "text-white font-mono font-bold text-xs pointer-events-none";
                        }
                        // TOMBOL END
                        else if (range.end !== null && i === range.end) {
                             btnClass = `glass-card p-1 rounded-lg border border-neonRed/50 text-center transition-all flex flex-col items-center justify-center min-h-[40px] ${isLast ? 'col-span-4 mt-2 bg-slate-800' : ''}`;
                             textClass = "text-neonRed font-mono font-bold text-xs pointer-events-none";
                        }
                    }
                    
                    btn.className = btnClass;
                    // Hati-hati menimpa innerHTML tombol 24 yg ada span tambahan
                    const spanLabel = btn.querySelector('span:first-child');
                    if(spanLabel) spanLabel.className = textClass;
                }

                // Update Status Text
                if (range.start !== null && range.end === null) {
                    statusEl.innerHTML = `Mulai: <span class="text-neonGold font-bold">${String(range.start).padStart(2,'0')}:00</span>... <span class="text-slate-500">(Klik angka lebih besar)</span>`;
                    btnConfirm.innerHTML = `PILIH WAKTU SELESAI...`;
                    btnConfirm.disabled = true;
                    btnConfirm.className = "flex-[2] bg-slate-800 text-slate-600 p-3 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 cursor-not-allowed border border-slate-700";
                } 
                else if (range.start !== null && range.end !== null) {
                    const duration = range.end - range.start;
                    const endLabel = range.end === 24 ? "24" : String(range.end).padStart(2,'0'); // Label 24
                    
                    statusEl.innerHTML = `Jadwal: <span class="text-neonCyan">${String(range.start).padStart(2,'0')}:00 - ${endLabel}:00</span> (${duration} Jam)`;
                    btnConfirm.innerHTML = `JADWALKAN SEKARANG`;
                    btnConfirm.disabled = false;
                    btnConfirm.className = "flex-[2] bg-neonCyan text-obsidian p-3 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(6,182,212,0.4)] hover:bg-white cursor-pointer active:scale-95";
                } 
                else {
                    statusEl.innerText = "Pilih JAM MULAI...";
                    btnConfirm.innerHTML = "PILIH WAKTU...";
                    btnConfirm.disabled = true;
                    btnConfirm.className = "flex-[2] bg-slate-800 text-slate-500 p-3 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 cursor-not-allowed";
                }
            },

            // Simpan Misi
            submitTimeRange() {
                if (!this.state.tempTask) return;
                const range = this.state.tempTimeRange;
                const tasks = Store.get('tasks');
                
                // Label Otomatis
                let timeLabel = "ALL DAY";
                let slotId = "all";
                
                if (!range.isAll) {
                    timeLabel = `${String(range.start).padStart(2,'0')}:00 - ${String(range.end).padStart(2,'0')}:00`;
                    slotId = `custom`; 
                }

                tasks.push({
                    id: Utils.generateId(),
                    text: this.state.tempTask.text,
                    difficulty: this.state.tempTask.difficulty,
                    timeSlot: slotId,
                    // SIMPAN DATA RANGE SPESIFIK
                    customStart: range.start,
                    customEnd: range.end,
                    customLabel: timeLabel,
                    
                    date: Utils.getTomorrow(), 
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });

                Store.set('tasks', tasks);
                this.closeModal();
                this.sound.play('success');
                this.toast('Misi terjadwal rapi!', 'success');
                this.render();
            },

            closeModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                setTimeout(() => m.innerHTML='', 300);
            },

            // --- RENDER ENGINE ---
            render() {
                // 1. Pre-Check Auto Fails before rendering
                const tasksRaw = Store.get('tasks');
                if(Engine.checkAutoFail(tasksRaw)) { Store.set('tasks', tasksRaw); }

                const tasks = Store.get('tasks');
                const rewards = Store.get('rewards');
                const reflections = Store.get('reflections');
                const financeData = Store.get('finance'); 
                const achievements = Store.get('achievements');
                const goals = Store.get('goals') || []; // Load Goals
                
                const today = Utils.getISO();
                const monthKey = Utils.getISO().slice(0, 7);
                const prevMonthKey = Utils.getISO(new Date(new Date().setMonth(new Date().getMonth() - 1))).slice(0,7);
                const currentSlot = Utils.getCurrentSlot();
                const currentHour = new Date().getHours();
                
                // Get Current Month Config
                const myFinance = financeData.find(f => f.month === monthKey);
                
                // Update Common Elements
                document.getElementById('header-month').innerText = Utils.formatMonth(monthKey);
                
                // Update Nav
                const navInner = document.getElementById('nav-inner');
                const tabs = [{id:'home',l:'PETA',i:'map'},{id:'rank',l:'RANK',i:'swords'},{id:'rewards',l:'GIFT',i:'gift'},{id:'history',l:'LOGS',i:'history'}];
                navInner.innerHTML = tabs.map(t => {
                    const act = this.state.view === t.id;
                    return `<button onclick="App.controller.navigate('${t.id}')" class="nav-item ${act?'active':''} flex flex-col items-center gap-1.5 p-2 w-16 group"><i data-lucide="${t.i}" class="nav-icon w-5 h-5"></i><span class="text-[8px] font-bold tracking-widest group-hover:text-white">${t.l}</span><div class="nav-indicator"></div></button>`;
                }).join('');

                const main = document.getElementById('app-viewport');
                
                const pts = Engine.calcPoints(tasks);

                if (this.state.view === 'home') {
                    
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    const ref = reflections.find(r => r.date === today);
                    
                    // [PERBAIKAN UTAMA] Ambil jam sekarang
                    const currentHour = new Date().getHours(); 

                    // Helper untuk membaca Start/End dari Misi (Baik Custom maupun ID)
                    const getTaskRange = (t) => {
                        // Prioritas 1: Cek properti customStart (dari input manual/loop)
                        if (t.customStart !== undefined && t.customStart !== null) {
                            return { start: t.customStart, end: t.customEnd };
                        }
                        // Prioritas 2: Cek dari ID slot (compatibility data lama)
                        const slot = Config.TIME_SLOTS.find(s => s.id === t.timeSlot);
                        // Jika slot 'all' atau tidak ketemu, default 0-24
                        return slot && slot.id !== 'all' ? { start: slot.start, end: slot.end } : { start: 0, end: 24 };
                    };

                    // 1. MISI GAGAL
                    const tFailed = Engine.sortTasks(tasks.filter(t => t.date === today && t.status === 'failed'));
                    
                    // 2. MISI SELESAI
                    const tCompleted = Engine.sortTasks(tasks.filter(t => t.date === today && t.status === 'completed'));

                    // 3. MISI AKTIF (Sedang Berlangsung)
                    const tActive = Engine.sortTasks(tasks.filter(t => {
                        // Harus hari ini dan status pending
                        if (t.date !== today || t.status !== 'pending') return false;
                        
                        // All Day selalu aktif
                        if (t.timeSlot === 'all') return true; 
                        
                        // Cek Matematika Jam
                        const { start, end } = getTaskRange(t);
                        // Aktif jika: Jam Sekarang >= Mulai DAN Jam Sekarang < Selesai
                        return currentHour >= start && currentHour < end;
                    }));
                    
                    // 4. MISI AKAN DATANG (Belum waktunya)
                    const tUpcoming = Engine.sortTasks(tasks.filter(t => {
                        if (t.date !== today || t.status !== 'pending') return false;
                        if (t.timeSlot === 'all') return false; // All day tidak masuk sini
                        
                        const { start } = getTaskRange(t);
                        // Upcoming jika: Jam Mulai > Jam Sekarang
                        return start > currentHour; 
                    }));

                    // ... (lanjut ke kode tTom / Misi Hari Ini di bawahnya seperti biasa) ...
                    
                    const tTom = Engine.sortTasks(tasks.filter(t => t.date === Utils.getTomorrow()));

                    const tTomPoints = tTom.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);

                    const diffBtn = (d) => {
                        const act = this.state.difficulty === d;
                        const c = Config.DIFFICULTY[d];
                        return `<button onclick="App.controller.setDifficulty('${d}')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border uppercase transition-all ${act ? `bg-white/10 text-white shadow-[0_0_10px_currentColor] ${c.border}` : 'border-slate-700 text-slate-500'}" style="${act?`color:${c.hex}`:''}">${c.label}</button>`;
                    };

                    // --- FINANCE SETUP CARD ---
                    let financeCard = '';
                    if (!myFinance) {
                        const selectedModeId = this.state.tempMode;
                        financeCard = `
                        <div class="glass-card p-5 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4 animate-[pulse-slow]">
                            <div class="flex items-center gap-2 mb-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-neonGold"></i>
                                <h3 class="text-sm font-bold text-white">Kalibrasi Protokol Bulan Ini</h3>
                            </div>
                            <p class="text-xs text-slate-400 mb-3 leading-relaxed">Agar kalkulasi nilai poin & rank akurat, masukkan parameter finansial & pilih mode operasi Anda.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Anggaran/Gaji (Rp)</label>
                                    <input id="income-in" type="number" placeholder="Contoh: 1800000" value="${this.state.tempIncome || ''}" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Alokasi Self Reward (%)</label>
                                    <select id="alloc-in" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                        <option value="0.1" ${this.state.tempAlloc === '0.1' ? 'selected' : ''}>10% (Mode Konservatif)</option>
                                        <option value="0.2" ${this.state.tempAlloc === '0.2' || !this.state.tempAlloc ? 'selected' : ''}>20% (Mode Seimbang)</option>
                                        <option value="0.3" ${this.state.tempAlloc === '0.3' ? 'selected' : ''}>30% (Mode Agresif)</option>
                                        <option value="0.4" ${this.state.tempAlloc === '0.4' ? 'selected' : ''}>40% (Mode Ekstrem)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Pilih Mode Operasi</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${Config.PRODUCTIVITY_MODES.map(m => {
                                            const isSel = selectedModeId === m.id;
                                            const border = isSel ? `border-${m.color.split('-')[1]}` : 'border-slate-700';
                                            const bg = isSel ? 'bg-slate-700' : 'bg-slate-800';
                                            return `
                                            <button onclick="App.controller.selectMode('${m.id}')" class="${bg} border ${border} hover:bg-slate-700 p-2 rounded-lg text-left transition-all active:scale-95 group relative overflow-hidden">
                                                ${isSel ? `<div class="absolute inset-0 bg-white/5"></div>` : ''}
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i data-lucide="${m.icon}" class="w-3 h-3 ${m.color}"></i>
                                                    <span class="text-xs font-bold text-white">${m.label}</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-[9px] text-slate-400">${m.desc}</span>
                                                    <span class="text-[10px] font-mono font-bold ${m.color}">${m.pts} Pts</span>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <button onclick="App.controller.saveMonthlyConfig()" class="w-full bg-neonGold text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg mt-2 flex justify-center items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Simpan Parameter</button>
                            </div>
                        </div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-8 pb-10 animate-[fadeIn_0.4s_ease-out]">
                        
                        ${financeCard}

                        <div class="flex gap-4">${ComponentFactory.rankCard('EXECUTION', rnk.exec, 'swords')}${ComponentFactory.rankCard('CONSISTENCY', rnk.cons, 'zap')}</div>
                        
                        ${ComponentFactory.analyticsCard(tasks)}

                        <!-- Poin Hari Ini -->
                        <div class="glass-card p-5 rounded-xl flex items-center justify-between relative overflow-hidden">
                            <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-neonCyan/10 to-transparent"></div>
                            <div class="relative z-10"><div class="text-[9px] text-neonCyan font-bold uppercase tracking-widest mb-1">Poin Hari Ini</div><div class="text-4xl font-mono font-bold text-white drop-shadow-md">${pts.cur} <span class="text-xs text-slate-500 font-sans font-normal">/ ${myFinance ? myFinance.targetPts : '-'} PTS</span></div></div>
                            <div class="relative z-10 w-12 h-12 rounded-full bg-slate border border-white/10 flex items-center justify-center"><i data-lucide="activity" class="text-neonCyan w-6 h-6"></i></div>
                        </div>

                        <!-- Rata-rata Harian -->
                        <div class="glass-card p-3 rounded-xl flex items-center justify-between border-l-2 border-neonPurple bg-white/5">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-lg bg-neonPurple/10"><i data-lucide="trending-up" class="w-4 h-4 text-neonPurple"></i></div>
                                <div>
                                    <p class="text-[9px] text-neonPurple font-bold uppercase tracking-widest">Rata-rata Harian</p>
                                    <p class="text-[8px] text-slate-400 font-mono">Performa Bulan Ini</p>
                                </div>
                            </div>
                            <div class="text-xl font-mono font-bold text-white tracking-wide">${pts.avg} <span class="text-[9px] text-slate-500 font-sans font-normal">PTS</span></div>
                        </div>

                        <!-- Stats Bulanan Grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-slate-600">
                                <span class="text-[8px] text-slate-400 uppercase tracking-widest mb-1">Bulan Lalu</span>
                                <span class="text-xl font-mono font-bold text-slate-300">${pts.last}</span>
                            </div>
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-neonCyan">
                                <span class="text-[8px] text-neonCyan uppercase tracking-widest mb-1">Bulan Ini</span>
                                <span class="text-xl font-mono font-bold text-white">${pts.mon}</span>
                            </div>
                        </div>

                        ${ref ? `<div class="glass-card p-5 rounded-xl border-l-4 border-l-neonPurple"><div class="flex items-center gap-2 mb-2 text-neonPurple"><i data-lucide="brain-circuit" class="w-4 h-4"></i><span class="text-[10px] font-bold uppercase tracking-widest">LOG REFLEKSI</span></div><p class="text-sm text-slate-200 italic">"${ref.text}"</p></div>` : 
                        `<div class="p-5 rounded-xl border border-dashed border-slate-700 bg-slate/20"><label class="block text-slate-400 text-[10px] font-bold mb-3 uppercase tracking-widest flex items-center gap-2"><i data-lucide="edit-3" class="w-3 h-3"></i> Refleksi Hari Ini</label><div class="flex gap-2"><input id="ref-in" type="text" placeholder="Apa yang dipelajari?" class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none"><button onclick="App.controller.saveRef()" class="bg-neonPurple text-white px-4 rounded-lg shadow-lg"><i data-lucide="save" class="w-4 h-4"></i></button></div></div>`}

                        <!-- SECTION: MISI GAGAL -->
                        ${tFailed.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonRed/20 pb-2">
                                <h2 class="text-sm font-bold text-neonRed flex items-center gap-2"><i data-lucide="alert-octagon" class="w-4 h-4"></i> TERLEWAT / GAGAL</h2>
                            </div>
                            <div class="space-y-0">${tFailed.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                          <!-- SECTION: MISI SELESAI -->
                        ${tCompleted.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonGreen/20 pb-2">
                                <h2 class="text-sm font-bold text-neonGreen flex items-center gap-2"><i data-lucide="check-circle-2" class="w-4 h-4"></i> SELESAI / SUKSES</h2>
                            </div>
                            <div class="space-y-0">${tCompleted.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                        <!-- SECTION: MISI AKTIF -->
                        <div>
                            <div class="flex justify-between mb-4 items-end border-b border-white/5 pb-2">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="crosshair" class="w-4 h-4 text-neonCyan"></i> MISI AKTIF</h2>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-neonCyan font-mono font-bold uppercase tracking-widest">${currentSlot.label} PHASE</span>
                                    <span class="text-[8px] text-slate-500 font-mono">${currentSlot.range}</span>
                                </div>
                            </div>
                            <div class="space-y-0">${tActive.length===0 ? '<div class="text-center py-8 text-xs text-slate-600 font-mono border border-dashed border-slate-800 rounded-xl">ISTIRAHAT / FASE KOSONG</div>' : tActive.map(t => ComponentFactory.taskItem(t, 'active')).join('')}</div>
                        </div>

                        <!-- SECTION: MISI AKAN DATANG -->
                        ${tUpcoming.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonPurple/20 pb-2">
                                <h2 class="text-sm font-bold text-neonPurple flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> AKAN DATANG HARI INI</h2>
                            </div>
                            <div class="space-y-0 opacity-80">${tUpcoming.map(t => ComponentFactory.taskItem(t, 'locked')).join('')}</div>
                        </div>` : ''}

                        <div class="flex items-center justify-center opacity-20 py-2"><div class="h-px bg-white w-full"></div><div class="mx-4 text-[9px] font-mono text-white whitespace-nowrap">NEXT CYCLE</div><div class="h-px bg-white w-full"></div></div>

                        <!-- SECTION: PERENCANAAN BESOK -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="sunrise" class="w-4 h-4 text-neonGold"></i> PERENCANAAN BESOK</h2>
                                <span class="text-[10px] font-mono text-neonGold border border-neonGold/30 px-2 py-1 rounded bg-neonGold/10">POTENSI: +${tTomPoints} PTS</span>
                            </div>
                            <div class="glass-card p-5 rounded-xl space-y-4 mb-4 relative group">
                               <!-- Tombol Besar Blueprint & Loop -->
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <button onclick="App.controller.openBlueprintManager()" class="glass-card p-3 rounded-xl border-t-2 border-neonCyan hover:bg-neonCyan/10 transition-all flex flex-col items-center gap-1 group active:scale-95">
                                        <div class="p-1.5 rounded-full bg-neonCyan/10 text-neonCyan group-hover:scale-110 transition-transform mb-1">
                                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-white uppercase tracking-widest">Blueprint</span>
                                        <span class="text-[8px] text-slate-500 font-mono">Load Template</span>
                                    </button>

                                    <button onclick="App.controller.openPeriodicModal()" class="glass-card p-3 rounded-xl border-t-2 border-neonPurple hover:bg-neonPurple/10 transition-all flex flex-col items-center gap-1 group active:scale-95">
                                        <div class="p-1.5 rounded-full bg-neonPurple/10 text-neonPurple group-hover:scale-110 transition-transform mb-1">
                                            <i data-lucide="repeat" class="w-4 h-4"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-white uppercase tracking-widest">Loop Misi</span>
                                        <span class="text-[8px] text-slate-500 font-mono">Auto Schedule</span>
                                    </button>
                                </div>

                                <input id="task-in" type="text" placeholder="Input nama misi..." value="${this.state.tempTaskInput || ''}" class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none pr-12">
                                <div class="flex gap-2">${['easy','medium','hard'].map(diffBtn).join('')}</div>
                                <div class="flex gap-2">
                                    <button onclick="App.controller.initTask()" class="flex-1 btn-action bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian font-bold py-3 rounded-lg text-xs uppercase tracking-widest shadow-[0_0_15px_rgba(6,182,212,0.3)] flex justify-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> Jadwalkan</button>
                                </div>
                            </div>
                            <div class="space-y-0">${tTom.map(t => ComponentFactory.taskItem(t, 'edit')).join('')}</div>
                        </div>
                    </div>`;
                } 
                else if (this.state.view === 'rank') {
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    let hHtml = '';
                    for(let i=1; i<=3; i++) {
                        const d = new Date(); d.setMonth(d.getMonth()-i);
                        const k = Utils.getISO(d).slice(0,7);
                        const r = Engine.calcRank(k, tasks, financeData);
                        hHtml += `
                        <div class="glass-card px-4 py-3 rounded-xl flex items-center justify-between mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${Utils.formatMonth(k)}</span>
                            <div class="flex gap-4">
                                <div class="flex items-center gap-2" title="Execution Rank">
                                    <span class="text-[8px] font-mono text-slate-600">EXEC</span>
                                    <span class="font-display text-base ${r.exec.tier.class}">${r.exec.tier.code}</span>
                                </div>
                                <div class="w-px h-4 bg-white/5"></div>
                                <div class="flex items-center gap-2" title="Consistency Rank">
                                    <span class="text-[8px] font-mono text-slate-600">CONS</span>
                                    <span class="font-display text-base ${r.cons.tier.class}">${r.cons.tier.code}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                    main.innerHTML = `
                    <div class="space-y-8 animate-[fadeIn_0.4s_ease-out] pt-4">
                        <div class="text-center"><div class="inline-block px-6 py-2 rounded-full border border-neonCyan/30 bg-neonCyan/10 backdrop-blur-md mb-2"><h2 class="text-neonCyan font-black text-sm uppercase tracking-[0.2em] drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">${Utils.formatMonth(monthKey)}</h2></div><p class="text-[10px] text-slate-500 uppercase tracking-widest">Laporan Kinerja Bulanan</p></div>
                        <div class="flex flex-col gap-4">${ComponentFactory.rankCard('EXECUTION RANK', rnk.exec, 'swords')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2 mb-2">SYARAT: SEMUA SELESAI (2x)</div>${ComponentFactory.rankCard('CONSISTENCY RANK', rnk.cons, 'zap')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2">SYARAT: CAPAI TARGET HARIAN (${rnk.dailyTarget} PTS)</div></div>
                        
                        <!-- NEW: Active Goal Section -->
                        <div class="pt-4 border-t border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="target" class="w-3 h-3 text-neonPurple"></i> Target Aktif</h3>
                                <button onclick="App.controller.openGoalModal()" class="text-[9px] bg-surface hover:bg-slate-700 text-neonPurple px-2 py-1 rounded border border-slate-700 flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> SET GOAL</button>
                            </div>
                            ${goals.length === 0 
                                ? `<div class="text-center py-6 text-[10px] text-slate-600 border border-dashed border-slate-800 rounded-xl italic">Belum ada target aktif.</div>` 
                                : `<div class="flex gap-3 overflow-x-auto pb-4 hide-scroll">${goals.map(g => ComponentFactory.goalCard(g)).join('')}</div>`
                            }
                        </div>

                        <!-- Updated: Achievement Section (Hall of Fame) -->
                        <div class="pt-4 border-t border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="medal" class="w-3 h-3 text-neonGold"></i> Hall of Fame (Riwayat)</h3>
                            </div>
                            
                            ${achievements.length === 0 
                                ? `<div class="text-center py-6 text-[10px] text-slate-600 border border-dashed border-slate-800 rounded-xl italic">Belum ada pencapaian legendaris.</div>` 
                                : `<div class="grid grid-cols-3 gap-2">
                                    ${Object.values(achievements.reduce((acc, a) => {
                                        if (!acc[a.goalId] || new Date(a.dateUnlocked) > new Date(acc[a.goalId].latest.dateUnlocked)) {
                                            acc[a.goalId] = { latest: a, count: (acc[a.goalId] ? acc[a.goalId].count + 1 : 1), all: (acc[a.goalId] ? [...acc[a.goalId].all, a] : [a]) };
                                        } else {
                                            acc[a.goalId].count++;
                                            acc[a.goalId].all.push(a);
                                        }
                                        return acc;
                                    }, {})).map(group => {
                                        if (group.count > 1 || goals.find(g => g.id === group.latest.goalId)?.type === 'progressive') {
                                            // Render Stack for progressive or multiple items
                                            return ComponentFactory.achievementStack(group.latest.goalId, group.all.sort((a,b) => new Date(a.dateUnlocked) - new Date(b.dateUnlocked)));
                                        } else {
                                            // Render Single
                                            return ComponentFactory.achievementBadge(group.latest);
                                        }
                                    }).join('')}
                                  </div>`
                            }
                            <p class="text-[8px] text-slate-600 mt-2 text-center">Rekaman sejarah tidak bisa diubah.</p>
                        </div>

                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="archive" class="w-3 h-3"></i> Arsip Bulanan</h3>${hHtml}</div>
                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Codex Pangkat</h3><div class="bg-charcoal/50 p-2 rounded-xl border border-white/5 h-64 overflow-y-auto custom-scroll">${ComponentFactory.rankLegend()}</div></div>
                    </div>`;
                }
             else if (this.state.view === 'rewards') {
                    const { total } = pts; 
                    const active = rewards.filter(r => r.status === 'active');
                    const allRedeemed = rewards.filter(r => r.status === 'redeemed');
                    
                    const settings = Store.get('settings');
                    const archivedSpent = settings.archivedSpent || 0;

                    // Total Spent
                    const totalSpent = allRedeemed.reduce((acc, r) => acc + (r.cost || 0), 0) + archivedSpent;
                    const walletBalance = total - totalSpent;
                    const isMinus = walletBalance < 0;

                    // Data Rupiah Bulan Ini
                    const curMonthKey = Utils.getMonthKey(Utils.getISO());
                    const redeemedThisMonth = allRedeemed.filter(r => r.redeemedDate && r.redeemedDate.startsWith(curMonthKey));
                    const expenseRupiahCurrent = redeemedThisMonth.reduce((acc, r) => acc + (r.price || 0), 0);

                    const myFinance = financeData.find(f => f.month === curMonthKey);
                    let financeSection = '';
                    
                    if (!myFinance) {
                          financeSection = `<div class="glass-card p-4 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4"><p class="text-xs text-white text-center"> Harap kalibrasi data finansial di menu <strong>PETA</strong>.</p></div>`;
                    } else {
                        const budgetRupiah = (myFinance.amount * myFinance.allocation);
                        const budgetPercent = budgetRupiah > 0 ? Math.min((expenseRupiahCurrent / budgetRupiah) * 100, 100) : 0;
                        const isOverBudget = expenseRupiahCurrent > budgetRupiah;
                        
                        financeSection = `
                        <div class="glass-card p-5 rounded-2xl border border-slate-700 bg-gradient-to-b from-slate-800 to-obsidian mb-6 relative overflow-hidden">
                            <!-- Header Label -->
                            <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                                    <i data-lucide="cpu" class="w-3 h-3 text-neonCyan"></i> NEURAL ASSETS
                                </h3>
                                <div class="px-2 py-0.5 rounded bg-slate-700 border border-slate-600">
                                    <span class="text-[8px] text-white font-mono">WALLET</span>
                                </div>
                            </div>

                            <!-- MAIN BALANCE -->
                            <div class="mb-5">
                                <span class="block text-[9px] text-slate-500 mb-1">SALDO SAAT INI</span>
                                <div class="flex items-baseline gap-1">
                                    <span class="${isMinus ? 'text-neonRed' : 'text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400'} font-mono font-black text-4xl tracking-tighter">
                                        ${Utils.formatCurrency(walletBalance)}
                                    </span>
                                    <span class="text-xs text-neonCyan font-bold">PTS</span>
                                </div>
                            </div>

                            <!-- STATS GRID -->
                            <div class="grid grid-cols-2 gap-4 pt-2">
                                <div>
                                    <div class="text-[8px] text-slate-500 uppercase tracking-widest mb-1">Lifetime Earned</div>
                                    <div class="text-xs font-mono text-white flex items-center gap-1">
                                        <i data-lucide="arrow-up-right" class="w-3 h-3 text-neonGreen"></i> ${Utils.formatCurrency(total)}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[8px] text-slate-500 uppercase tracking-widest mb-1">Total Burned</div>
                                    <div class="text-xs font-mono text-white flex items-center justify-end gap-1">
                                        ${Utils.formatCurrency(totalSpent)} <i data-lucide="flame" class="w-3 h-3 text-neonRed"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- MONEY TRACKER (Dengan Limit) -->
                            <div class="relative z-10 pt-4 mt-2 border-t border-white/5">
                                <div class="flex justify-between text-[10px] mb-1.5">
                                    <span class="text-slate-400">Money Burn (Bulan Ini)</span>
                                    <span class="${isOverBudget ? 'text-neonRed font-bold animate-pulse' : 'text-slate-300'} font-mono">
                                        Rp ${Utils.formatCurrency(expenseRupiahCurrent)}
                                    </span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                                    <div class="h-full ${isOverBudget ? 'bg-neonRed' : 'bg-neonCyan'} transition-all duration-1000" style="width: ${budgetPercent}%"></div>
                                </div>
                                
                                <!-- [FIX] LIMIT DITAMPILKAN KEMBALI DI SINI -->
                                <div class="text-right mt-1.5 flex justify-end items-center gap-1">
                                    <span class="text-[8px] text-slate-600 uppercase tracking-wider">BATAS ANGGARAN:</span>
                                    <span class="text-[9px] text-slate-500 font-mono font-bold">Rp ${Utils.formatCurrency(budgetRupiah)}</span>
                                </div>
                            </div>
                        </div>`;
                    }

                    // Form Input Reward (Tetap sama)
                    let rewardForm = ''; 
                    if (this.state.rewardStep === 0) {
                          rewardForm = `<div class="flex gap-2"><input id="rew-name" type="text" placeholder="Ketik barang impian..." class="w-full bg-charcoal text-white rounded-xl px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none shadow-inner"><button onclick="App.controller.initReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-xl font-bold transition-all shadow-lg active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i></button></div>`;
                    } else if (this.state.rewardStep === 1) {
                        rewardForm = `<div class="text-center py-2 animate-[fadeIn_0.3s]"><p class="text-white text-xs font-bold mb-3">Ada harga nominal (Rp)?</p><div class="flex gap-3 justify-center"><button onclick="App.controller.setRewardHasPrice(false)" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700 text-xs">Tidak</button><button onclick="App.controller.setRewardHasPrice(true)" class="px-4 py-2 rounded-lg bg-neonPurple text-white hover:bg-neonPurple/80 shadow-lg text-xs font-bold">Ya</button></div></div>`;
                    } else if (this.state.rewardStep === 2) {
                          const showPriceInput = this.state.tempReward.hasPrice;
                          rewardForm = `<div class="space-y-3 animate-[fadeIn_0.3s]"><div class="flex items-center justify-between text-xs text-slate-400 px-1"><span>Item: <strong class="text-white">${this.state.tempReward.name}</strong></span><button onclick="App.controller.resetRewardForm()" class="text-neonRed hover:underline">Batal</button></div>${showPriceInput ? `<input id="rew-price" type="number" onkeyup="App.controller.calcRewardRecs()" placeholder="Harga (Rp)..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none">` : ''}<div id="rec-container"></div><div class="flex gap-2"><input id="rew-cost" type="number" placeholder="Target Poin (Cost)..." class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none"><button onclick="App.controller.saveReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-lg font-bold transition-all shadow-lg"><i data-lucide="check" class="w-5 h-5"></i></button></div></div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.4s_ease-out] pt-4 pb-24">
                        ${financeSection}

                        ${isMinus ? `<div class="text-center mb-2"><button onclick="App.controller.resetRedeemedRewards()" class="text-[10px] bg-neonRed text-obsidian font-bold px-3 py-1 rounded hover:bg-white transition-colors"> RESET DATA BELANJA (FIX MINUS)</button></div>` : ''}

                        <div class="space-y-2">
                            <div class="glass-card p-4 rounded-xl space-y-3 border border-white/5 bg-slate-800/30">${rewardForm}</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between px-1">
                                <h3 class="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4 text-neonPurple"></i> Wishlist Market</h3>
                                <span class="text-[9px] text-slate-500 bg-white/5 px-2 py-1 rounded-lg">${active.length} ITEM</span>
                            </div>

                            ${active.length===0 ? '<div class="text-center py-10 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">BELUM ADA TARGET BELANJA</div>' : active.map(r => {
                                const canClaim = walletBalance >= r.cost;
                                const progress = r.cost > 0 ? Math.min((walletBalance/r.cost)*100, 100) : 0;
                                const deficit = r.cost - walletBalance;
                                
                                return `
                                <div class="glass-card p-4 rounded-xl relative overflow-hidden group border transition-all duration-300 ${canClaim ? 'border-neonGreen/50' : 'border-white/5 hover:border-white/10'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="text-white font-bold text-sm tracking-wide group-hover:text-neonCyan transition-colors">${r.name}</h4>
                                            ${r.price ? `<div class="text-[10px] text-slate-400 font-mono mt-0.5">Rp ${Utils.formatCurrency(r.price)}</div>` : ''}
                                        </div>
                                        <div class="flex flex-col items-end gap-2">
                                             <button onclick="App.controller.delReward('${r.id}')" class="p-1 text-slate-600 hover:text-neonRed transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>

                                    <!-- KOLAM ENERGI (PROGRESS BAR) -->
                                    <div class="mt-3 mb-2">
                                        <div class="flex justify-between text-[9px] mb-1">
                                            <span class="text-slate-500 font-bold">PROGRESS</span>
                                            <span class="font-mono ${canClaim ? 'text-neonGreen' : 'text-white'}">${Math.floor(progress)}%</span>
                                        </div>
                                        <!-- Wadah Kolam -->
                                        <div class="w-full h-3 bg-slate-900/80 rounded border border-slate-700 relative overflow-hidden">
                                            <!-- Isi Kolam -->
                                            <div class="h-full ${canClaim ? 'bg-neonGreen shadow-[0_0_10px_#10b981]' : 'bg-neonPurple'} transition-all duration-1000" style="width:${progress}%"></div>
                                        </div>
                                    </div>

                                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-white/5">
                                        <div class="font-mono text-xs text-white">
                                            ${r.cost} <span class="text-[8px] text-slate-500">PTS</span>
                                        </div>
                                        <div>
                                            ${canClaim ? 
                                                `<button onclick="App.controller.claimReward('${r.id}')" class="bg-neonGreen hover:bg-white text-obsidian text-[10px] font-bold px-4 py-1.5 rounded shadow-lg transition-transform active:scale-95 flex items-center gap-2"><i data-lucide="shopping-cart" class="w-3 h-3"></i> BELI</button>` 
                                                : 
                                                `<span class="text-[9px] font-mono text-neonRed flex items-center gap-1 bg-neonRed/10 px-2 py-1 rounded border border-neonRed/20"><i data-lucide="lock" class="w-3 h-3"></i> Kurang ${deficit}</span>`
                                            }
                                        </div>
                                    </div>
                                </div>`
                            }).join('')}
                        </div>
                        
                        <!-- History Belanja -->
                        <div class="pt-6 border-t border-white/5 space-y-4 opacity-80 hover:opacity-100 transition-opacity">
                            <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2">
                                <i data-lucide="history" class="w-3 h-3"></i> Riwayat Transaksi (Bulan Ini)
                            </h3>
                            ${redeemedThisMonth.length === 0 ? '<div class="text-center py-4 text-[10px] text-slate-700">Belum ada transaksi.</div>' : redeemedThisMonth.map(r=>`
                                <div class="flex items-center justify-between p-3 rounded-lg border border-white/5 bg-white/[0.02]">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded bg-white/5 text-slate-400"><i data-lucide="check" class="w-3 h-3"></i></div>
                                        <div>
                                            <p class="text-slate-300 text-xs font-bold">${r.name}</p>
                                            <p class="text-[8px] text-slate-600">${Utils.formatDate(r.redeemedDate)}</p>
                                        </div>
                                    </div>
                                    <div class="text-neonRed text-xs font-mono font-bold">-${r.cost}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
               else if (this.state.view === 'history') {
                    const [hy, hm] = this.state.histMonth.split('-');
                    const dim = new Date(hy, hm, 0).getDate();
                    const fDay = new Date(hy, parseInt(hm)-1, 1).getDay();
                    
                    // Logika Offset (Senin = hari pertama)
                    const offset = fDay === 0 ? 6 : fDay - 1; 
                    
                    const days = Array.from({length:dim},(_,i)=>`${this.state.histMonth}-${String(i+1).padStart(2,'0')}`);
                    const sd = this.state.histDate;
                    const today = Utils.getISO(); // Ambil tanggal hari ini
                    
                    const sTasks = sd ? Engine.sortTasks(tasks.filter(t=>t.date===sd)) : [];
                    const sRef = sd ? reflections.find(r=>r.date===sd) : null;
                    const histRank = Engine.calcRank(this.state.histMonth, tasks, financeData);
                    
                    const histTasksAll = tasks.filter(t => t.date.startsWith(this.state.histMonth) && t.status === 'completed');
                    const histTotalPoints = histTasksAll.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);
                    
                    const histRewards = rewards.filter(r => r.status === 'redeemed' && r.redeemedDate && r.redeemedDate.startsWith(this.state.histMonth)).sort((a,b) => new Date(b.redeemedDate) - new Date(a.redeemedDate));
                    const totalHistPointsSpent = histRewards.reduce((acc, r) => acc + (r.cost || 0), 0);
                    const totalHistRupiah = histRewards.reduce((acc, r) => acc + (r.price || 0), 0);

                    // --- GENERATE KALENDER ---
                    let grid = '';
                    
                    // 1. Header Hari (SEN - MIN)
                    const weekDays = ['SEN', 'SEL', 'RAB', 'KAM', 'JUM', 'SAB', 'MIN'];
                    weekDays.forEach(day => {
                        grid += `<div class="text-[8px] font-bold text-slate-600 text-center py-1">${day}</div>`;
                    });

                    // 2. Kotak Kosong (Offset)
                    for(let i=0; i<offset; i++) grid += `<div class="aspect-square"></div>`;
                    
                    // 3. Tanggal
                    days.forEach(d => {
                        const isToday = (d === today);
                        const dayTasks = tasks.filter(t=>t.date===d);
                        const has = dayTasks.length>0;
                        const all = has && dayTasks.every(t=>t.status==='completed');
                        const fail = dayTasks.some(t=>t.status==='failed');
                        
                        let bg='bg-slate-800/30 text-slate-500', br='border-transparent';
                        
                        // Warna status misi
                        if(has) { 
                            if(all){ bg='bg-neonGreen/20 text-white'; br='border-neonGreen/30' } 
                            else if(fail){ bg='bg-neonRed/20 text-white'; br='border-neonRed/30' } 
                            else { bg='bg-neonPurple/20 text-white'; br='border-neonPurple/30' } 
                        }
                        
                        // Style jika "Hari Ini" (Border Cyan Terang)
                        if (isToday) {
                            br = 'border-neonCyan shadow-[0_0_10px_rgba(6,182,212,0.3)]';
                            if(!has) bg = 'bg-slate-700 text-white'; 
                        }

                        // Style jika "Diklik/Dipilih" (Solid Block)
                        if(sd===d) { 
                            bg='bg-neonCyan text-obsidian font-bold shadow-[0_0_15px_rgba(6,182,212,0.6)]'; 
                            br='border-white'; 
                        }

                        grid += `<button onclick="App.controller.setDate('${d}')" class="cal-cell aspect-square rounded-lg flex flex-col items-center justify-center text-xs border ${br} ${bg} transition-all hover:scale-105 active:scale-95 relative overflow-hidden">
                            ${new Date(d).getDate()}
                            ${isToday ? '<div class="absolute bottom-0.5 w-1 h-1 bg-white rounded-full"></div>' : ''}
                        </button>`;
                    });

                    main.innerHTML = `
                    <div class="pt-2 animate-[fadeIn_0.4s_ease-out] pb-24">
                        
                        <!-- Month Nav -->
                        <div class="flex items-center justify-between glass-card p-2 rounded-xl mb-4">
                            <button onclick="App.controller.navMonth(-1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 group">
                                <i data-lucide="chevron-left" class="w-5 h-5 group-active:-translate-x-1 transition-transform"></i>
                            </button>
                            <span class="text-white font-black text-sm tracking-[0.2em]">${Utils.formatMonth(this.state.histMonth)}</span>
                            <button onclick="App.controller.navMonth(1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 group">
                                <i data-lucide="chevron-right" class="w-5 h-5 group-active:translate-x-1 transition-transform"></i>
                            </button>
                        </div>

                        <!-- Stats Summary -->
                        <div class="mb-6">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div class="glass-card p-3 rounded-xl border-l-2 border-neonGreen bg-gradient-to-br from-green-900/20 to-transparent relative overflow-hidden group">
                                    <div class="absolute right-[-10px] top-[-10px] bg-neonGreen/10 w-16 h-16 rounded-full blur-xl group-hover:bg-neonGreen/20 transition-all"></div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="p-1.5 rounded-lg bg-neonGreen/10 text-neonGreen"><i data-lucide="trending-up" class="w-4 h-4"></i></div>
                                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Masuk</span>
                                    </div>
                                    <div class="text-xl font-mono font-bold text-white tracking-tight">${histTotalPoints} <span class="text-[10px] text-slate-500 font-sans">Pts</span></div>
                                </div>

                                <div class="glass-card p-3 rounded-xl border-l-2 border-neonRed bg-gradient-to-br from-red-900/20 to-transparent relative overflow-hidden group">
                                    <div class="absolute right-[-10px] top-[-10px] bg-neonRed/10 w-16 h-16 rounded-full blur-xl group-hover:bg-neonRed/20 transition-all"></div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="p-1.5 rounded-lg bg-neonRed/10 text-neonRed"><i data-lucide="trending-down" class="w-4 h-4"></i></div>
                                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Keluar</span>
                                    </div>
                                    <div class="text-xl font-mono font-bold text-white tracking-tight">${totalHistPointsSpent} <span class="text-[10px] text-slate-500 font-sans">Pts</span></div>
                                </div>
                            </div>

                            <!-- [FIX] MONEY BURN SIMPLE -->
                            <div class="glass-card px-4 py-3 rounded-xl border border-white/5 bg-slate-800/30">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="flame" class="w-3 h-3 text-neonRed"></i> MONEY BURN
                                    </span>
                                    <span class="text-sm font-mono font-bold text-neonRed">Rp ${Utils.formatCurrency(totalHistRupiah)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- COMPACT RANK CARDS -->
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <!-- Execution Rank Kecil -->
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-slate-600 bg-white/5">
                                <span class="text-[8px] text-slate-400 uppercase tracking-widest mb-1 flex items-center gap-1"><i data-lucide="swords" class="w-3 h-3"></i> EXECUTION</span>
                                <span class="text-3xl font-display ${histRank.exec.tier.class} drop-shadow-lg">${histRank.exec.tier.code}</span>
                            </div>
                            <!-- Consistency Rank Kecil -->
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-neonCyan bg-white/5">
                                <span class="text-[8px] text-neonCyan uppercase tracking-widest mb-1 flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> CONSISTENCY</span>
                                <span class="text-3xl font-display ${histRank.cons.tier.class} drop-shadow-lg">${histRank.cons.tier.code}</span>
                            </div>
                        </div>

                        <!-- [FIX] CALENDAR GRID WITH HEADERS -->
                        <div class="cal-grid mb-6">
                            ${grid}
                        </div>

                        ${sd ? `
                        <div class="animate-[slideIn_0.3s_ease-out]">
                            <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-4 pl-2 border-l-2 border-neonCyan flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-neonCyan"></i>
                                ${Utils.formatDate(sd)}
                            </h3>

                            ${sRef ? `
                            <div class="glass-card p-4 rounded-xl border-l-4 border-l-neonPurple mb-4">
                                <div class="flex items-center gap-2 mb-2 text-neonPurple">
                                    <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                                    <span class="text-[10px] font-bold uppercase tracking-widest">LOG REFLEKSI</span>
                                </div>
                                <p class="text-sm text-slate-200 italic">"${sRef.text}"</p>
                            </div>` : '<div class="text-center py-4 text-[10px] text-slate-600 border border-dashed border-slate-800 rounded-xl mb-4">Tidak ada catatan refleksi.</div>'}

                            <div class="space-y-0">
                                ${sTasks.length === 0 ? '<div class="text-center py-8 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">TIDAK ADA DATA MISI</div>' : sTasks.map(t => ComponentFactory.taskItem(t, true)).join('')}
                            </div>
                        </div>` : '<div class="text-center py-10 text-slate-600 italic text-xs">Pilih tanggal untuk melihat detail arsip.</div>'}
                    </div>`;
                }
                
                lucide.createIcons();
            }
        };

        // INITIALIZE APP
        const App = { controller: Controller };
        window.onload = () => App.controller.init();

    </script>
</body>
</html>

